<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>MapLibre Architecture</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> Intro</a></li><li class="chapter-item expanded affix "><li class="part-title">Architecture</li><li class="chapter-item expanded "><a href="architecture/Collision-Detection.html"><strong aria-hidden="true">2.</strong> Collision Detection</a></li><li class="chapter-item expanded "><a href="architecture/Threading-structure.html"><strong aria-hidden="true">3.</strong> Threading structure</a></li><li class="chapter-item expanded "><a href="architecture/Expression-Architecture.html"><strong aria-hidden="true">4.</strong> Expression Architecture</a></li><li class="chapter-item expanded "><a href="architecture/Text-Rendering.html"><strong aria-hidden="true">5.</strong> Text Rendering</a></li><li class="chapter-item expanded affix "><li class="part-title">Rendering</li><li class="chapter-item expanded "><a href="rendering/Coordinate-Systems.html"><strong aria-hidden="true">6.</strong> Coordinate Systems</a></li><li class="chapter-item expanded "><a href="rendering/OpenGL-Docs.html"><strong aria-hidden="true">7.</strong> OpenGL Docs</a></li><li class="chapter-item expanded affix "><li class="part-title">Android</li><li class="chapter-item expanded "><a href="android/Setting-up-Mapbox-checkstyle.html"><strong aria-hidden="true">8.</strong> Setting up Mapbox checkstyle</a></li><li class="chapter-item expanded "><a href="android/Android-5.x-to-6.x-migration-guide.html"><strong aria-hidden="true">9.</strong> Android 5.x to 6.x migration guide</a></li><li class="chapter-item expanded "><a href="android/Android-6.x-to-7.x-migration-guide.html"><strong aria-hidden="true">10.</strong> Android 6.x to 7.x migration guide</a></li><li class="chapter-item expanded "><a href="android/Getting-line-numbers-from-an-Android-crash-with-ndk-stack.html"><strong aria-hidden="true">11.</strong> Getting line numbers from an Android crash with ndk stack</a></li><li class="chapter-item expanded "><a href="android/Android-4.x-to-5.x-migration-guide.html"><strong aria-hidden="true">12.</strong> Android 4.x to 5.x migration guide</a></li><li class="chapter-item expanded "><a href="android/Strategies-to-reduce-Android-APK-size.html"><strong aria-hidden="true">13.</strong> Strategies to reduce Android APK size</a></li><li class="chapter-item expanded affix "><li class="part-title">Apple</li><li class="chapter-item expanded "><a href="apple/GPUs.html"><strong aria-hidden="true">14.</strong> GPUs</a></li><li class="chapter-item expanded "><a href="apple/Upgrading-from-Mapbox-Maps-SDK-for-iOS-v3.7.x-to-v4.0.x.html"><strong aria-hidden="true">15.</strong> Upgrading from Mapbox Maps SDK for iOS v3.7.x to v4.0.x</a></li><li class="chapter-item expanded affix "><li class="part-title">Releasing</li><li class="chapter-item expanded "><a href="releasing/Merge-release-branch-into-master.html"><strong aria-hidden="true">16.</strong> Merge release branch into master</a></li><li class="chapter-item expanded "><a href="releasing/Releasing-the-Mapbox-macOS-SDK.html"><strong aria-hidden="true">17.</strong> Releasing the Mapbox macOS SDK</a></li><li class="chapter-item expanded "><a href="releasing/Releasing-the-Mapbox-iOS-SDK.html"><strong aria-hidden="true">18.</strong> Releasing the Mapbox iOS SDK</a></li><li class="chapter-item expanded affix "><li class="part-title">Workflow</li><li class="chapter-item expanded "><a href="workflow/JS-Native-workflow.html"><strong aria-hidden="true">19.</strong> JS Native workflow</a></li><li class="chapter-item expanded "><a href="workflow/Code-Structure.html"><strong aria-hidden="true">20.</strong> Code Structure</a></li><li class="chapter-item expanded "><a href="workflow/Versions-and-tagging.html"><strong aria-hidden="true">21.</strong> Versions and tagging</a></li><li class="chapter-item expanded "><a href="workflow/Troubleshooting.html"><strong aria-hidden="true">22.</strong> Troubleshooting</a></li><li class="chapter-item expanded "><a href="workflow/Building-with-Xcode.html"><strong aria-hidden="true">23.</strong> Building with Xcode</a></li><li class="chapter-item expanded affix "><li class="part-title">Misc</li><li class="chapter-item expanded "><a href="misc/Release-notes-style-guide.html"><strong aria-hidden="true">24.</strong> Release notes style guide</a></li><li class="chapter-item expanded "><a href="misc/Using-Mapbox-iOS-SDK-in-an-Interface-Builder-storyboard.html"><strong aria-hidden="true">25.</strong> Using Mapbox iOS SDK in an Interface Builder storyboard</a></li><li class="chapter-item expanded "><a href="misc/Terminology-across-platforms.html"><strong aria-hidden="true">26.</strong> Terminology across platforms</a></li><li class="chapter-item expanded "><a href="misc/Release-notes-template-for-macOS.html"><strong aria-hidden="true">27.</strong> Release notes template for macOS</a></li><li class="chapter-item expanded "><a href="misc/Prototyping-with-Framer.js.html"><strong aria-hidden="true">28.</strong> Prototyping with Framer</a></li><li class="chapter-item expanded "><a href="misc/Prerelease-notes-template-for-macOS.html"><strong aria-hidden="true">29.</strong> Prerelease notes template for macOS</a></li><li class="chapter-item expanded "><a href="misc/Bitrise-workflow-details.html"><strong aria-hidden="true">30.</strong> Bitrise workflow details</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">MapLibre Architecture</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="maplibre-architecture"><a class="header" href="#maplibre-architecture">MapLibre Architecture</a></h1>
<p>View it <a href="https://maxammann.github.io/maplibre-architecture/">here</a>.</p>
<p>This was forked from the mapbox-gl-native <a href="https://github.com/mapbox/mapbox-gl-native/wiki">wiki</a> commit <a href="https://github.com/mapbox/mapbox-gl-native/wiki/Text-Rendering/1640f7f5ada816e335b3b71cadaba80ce29fa7bb">1640f7f</a> (Apr 27, 2020).</p>
<p>maplibre-gl-native was forked from <a href="../d60fd302b1f6563e7d16952f8855122fdcc85f73">d60fd30</a> which happened on Apr 30, 2020.</p>
<p>The documentation is also valid for maplibre-gl-native. Most of it is also valid for maplibre-gl-js.</p>
<h2 id="contributing"><a class="header" href="#contributing">Contributing</a></h2>
<p>Issues are disabled in this repo. If you want to contribute directly create a PR.</p>
<h2 id="license"><a class="header" href="#license">License</a></h2>
<p>Up until commit 1640f7f:</p>
<pre><code class="language-js">console.log([][[]])
</code></pre>
<p>Changes after 1640f7f:</p>
<p>MIT</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mapbox-gl-collision-detection"><a class="header" href="#mapbox-gl-collision-detection">Mapbox GL Collision Detection</a></h1>
<p>This document is meant to capture the overall architecture of symbol collision detection at the end of 2017, after making the change to global (e.g. cross-source) viewport-based collision detection.</p>
<p>Mapbox vector tiles contain a collection of features to draw on a map, along with labels (either text or icons, generically called “symbols”) to attach to those features. Generally, the set of labels in a tile is larger than the set of labels that can be displayed on the screen at one time without overlap. To preserve legibility, we automatically choose subsets of those labels to display on the screen for any given frame: this is what we call “collision detection”. The set of labels that we choose can change dramatically as camera parameters change (pitch/rotation/zoom/etc.) because in general the shape of text itself will not be affected the same way as the underlying geometry the text is attached to.</p>
<p><strong>Collision Detection Desiderata</strong></p>
<ul>
<li>Correct: Labels don’t overlap!</li>
<li>Prioritized: More important labels are chosen before less important labels</li>
<li>Deterministic: viewing the same map data from the same camera perspective will always generate the same results</li>
<li>Stable: During camera operations such as panning/zooming/rotating, labels should not disappear unless there’s no longer space for them on the screen</li>
<li>Global: collision detection should account for all labels on the screen, no matter their source</li>
<li>Smooth: when collisions happen, we should be able to animate fade transitions to remove “collided” labels</li>
<li>Fast: collision detection should be integrated into a 60 FPS rendering loop, which means synchronous calculations that take more than a few milliseconds are unacceptable. On the other hand, latency of a couple hundred milliseconds in actually detecting a new collision is perceptually acceptable.</li>
</ul>
<h2 id="basic-strategy"><a class="header" href="#basic-strategy">Basic Strategy</a></h2>
<p>The core of our collision detection algorithm uses a two-dimensional spatial data structure we call a <code>GridIndex</code> that is optimized for fast insertion and fast querying of “bounding geometries” for symbols on the map. Every time we run collision detection, we go through the set of all items we’d like to display, in order of their importance:</p>
<ol>
<li>We use information about the size/style/position of the label, along with the current camera position, to calculate a bounding geometry for the symbol as it will display on the current screen</li>
<li>We check if the bounding geometry for the symbol fits in unused space in the <code>GridIndex</code>.</li>
<li>If there’s room, we insert the geometry, thereby marking the space as “used”. Otherwise, we mark this label “collided” and move on to the next label</li>
</ol>
<p>The “global”, “smooth”, and “fast” desiderata add an important challenge for Mapbox GL because Mapbox maps are frequently combining data from multiple sources, and any change in any of the sources can potentially affect symbols from all of the other sources (because of “cascade” effects, introducing a symbol B that blocks symbol A could open up room for symbol C to display, which could in turn block a previously-showing symbol D…). To manage this challenge, we use a data structure we call the <code>CrossTileSymbolIndex</code> which allows us to globally synchronize collision detection (and symbol fade animation).</p>
<h2 id="gridindex"><a class="header" href="#gridindex"><code>GridIndex</code></a></h2>
<p>The <code>GridIndex</code> is a two-dimensional spatial data structure. Although the data structure itself is context-agnostic, in practice we use a <code>GridIndex</code> in which the 2D plane is the “viewport” — that is, the plane of the device’s screen. This is in contrast to the “tile” or “map” plane used to represent our underlying data. While most map-drawing logic is easiest to process in “map” coordinates, “viewport” coordinates are a better fit for text because in general we prefer text that is aligned flat relative to the screen.</p>
<p><code>GridIndex</code> holds two types of geometries:</p>
<ul>
<li>Rectangles: used to represent “point” labels (e.g. a city name)</li>
<li>Circles: used to represent “line” labels (e.g. a street name that follows the curve of the street)</li>
</ul>
<p>We limit ourselves to these two geometry types because it easy to quickly test for the three possible types of intersection (rectangle-rectangle, circle-circle, and rectangle-circle).</p>
<p><strong>Rectangles</strong>
Rectangles are a fairly good fit for point labels because:</p>
<ul>
<li>Text in point labels is laid out in a straight line</li>
<li>Point labels are <em>generally</em> oriented to the viewport, which means their orientation won’t change during map rotation (although their position will change)</li>
<li>Multi-line point labels are, as much as possible, balanced so that the lines approximate a rectangle: https://github.com/mapbox/hey/issues/6079</li>
<li>Text is <em>generally</em> drawn on the viewport plane (i.e. flat relative to the screen). When it is drawn “pitched” (i.e. flat relative to the map), a viewport-aligned rectangle can still serve as a reasonable approximation, because the pitched projection of the text will be a trapezoid circumscribed by the rectangle.</li>
</ul>
<p><strong>Circles</strong>
Line labels are represented as a series of circles that follow the course of the underlying line geometry across the length of the label. The circles are chosen so that (1) both the beginning and end of the label will be covered by circles, (2) along the line, the gap between adjacent circles will never be too large, (3) for performance reasons, adjacent circles won’t significantly overlap. The code that chooses which circles to use for a label is tightly integrated with the line label rendering code, and it’s also code we’re thinking of changing: I’ll consider it out of scope for this document.</p>
<p>Representing a label as several circles is more expensive than representing it as a single rectangle, but still relatively cheap. Using multiple circles allows us to approximate arbitrary line geometries (and in fact there are outstanding feature requests that would require us to support other arbitrary collision geometries such as “don’t let labels get drawn over this lake” — we would probably implement support by converting those geometries into circles first).</p>
<p>The key benefit of circles relative to rectangles is that they are <em>stable under rotation</em>. Since line labels are attached to map geometry, they necessarily rotate with the map, unlike point labels, which are usually fixed to the viewport orientation. If we were using small rectangles to represent line labels (as we did before the most recent changes), then the <em>viewport-aligned</em> rectangles would rotate relative to the map during map rotation. The rotation change alone could cause two adjacent line labels to collide, violating our “stability” desideratum. Circles, on the other hand, are conveniently totally unaffected by rotation.</p>
<p><strong>The Grid</strong>
The “grid” part of <code>GridIndex</code> is a technique for making queries faster that relies on the assumption that most geometries that are stored in the index will only occupy a relatively small portion of the plane. When we use the <code>GridIndex</code> to represent a (for example) 600px by 600px viewport, we split the 600x600px plane into a grid of 400 (20x20) 30px-square “cells”.</p>
<p>For each bounding geometry we insert, we check to see which cells the geometry intersects with, and make an entry in that cell representing a pointer to the bounding geometry. So for example a rectangle that spans from [x: 10, y: 10] to [x: 70, y: 20] would be inserted into the first three cells in the grid (which would span from [0,0] to [90, 30]).</p>
<p>When we want to test if a bounding geometry intersects with something already in the <code>GridIndex</code>, we first find the set of cells it intersects with. Then, for each of the cells it intersects with, we look up the set of bounding geometries contained in that cell, and directly test the geometries for intersection.</p>
<p>Given the assumption that bounding geometries are relatively uniformly distributed (which is a reasonable assumption for map labels), this approach has an attractive algorithmic property: doubling the dimensions of the index (and thus roughly doubling the number of entries) is not expected to have a significant impact on the cost of a query against the index. This is because for any given query the cost of finding the right cells is near constant, and the number of comparisons to run against each cell is a function of the <em>density</em> of the index, but not its overall size. Since our collision detection algorithm has to test every label for collision against every other label, near-constant-time queries allow us to keep collision detection time linear in the number of labels.</p>
<p>If the cell size is too small, the “fixed” part of a query (looking up cells) becomes too expensive, while if the cell size is too large, the index degenerates towards a case in which every geometry has to be compared against every other geometry on every query. We derived the 30px-square cell size by experimental profiling of common map animations. Conceptually, this is roughly the smallest size at which individual “collision circles” for 16px-high are <em>likely</em> to fit within a single cell and at most four cells. Optimizing for individual circles makes sense because the most expensive collision detection scenario for us is a dense network of road labels, which will be almost entirely represented with circles.</p>
<h2 id="crosstilesymbolindex"><a class="header" href="#crosstilesymbolindex"><code>CrossTileSymbolIndex</code></a></h2>
<p>We satisfy the  “smooth” desideratum by using animations to fade symbols in (when they’re newly allowed to appear) and out (when they collide with another label). However, our tile-based map presents a challenge: symbols that are logically separate (e.g. “San Francisco” at zoom level 10 and “San Francisco” at z11) may be <em>conceptually</em> tied together, and the user expects consistent animation between the them (i.e. “San Francisco” should not fade out and fade back in when the z10 version is replaced by the z11 version, and if “San Francisco” is fading in while the zoom level is changing, the animation shouldn’t be interrupted by the zoom level change).</p>
<p>The <code>CrossTileSymbolIndex</code> solves this problem by providing a global index of all symbols, which identifies “duplicate” symbols across different zoom levels and assigns them a shared unique identifier called a <code>crossTileID</code>.</p>
<p><strong>Opacities</strong>
Uploading data to the GPU is expensive, so to satisfy the “fast” desideratum, the only data we upload as a result of collision detection is a small “symbol opacity”, which is a “current opacity” between 0 and 1, and a “target opacity” of either 0 or 1.  The shader running on the GPU is responsible for interpolating between the current opacity and the target opacity using a clock parameter passed in as an argument.</p>
<p>The output of the collision detection algorithm is used to set the target opacity of every symbol to either 0 or 1. Every time the opacities are updated by collision detection, the “clock parameter” is essentially reset to zero, and the CPU re-calculates the baseline “current opacity”. One way to conceptualize this is “if the current opacity is different from the target opacity, a fade animation is in progress”.</p>
<p>Working with the shared, unique <code>crossTileID</code> makes it easy to handle smooth animations between zoom levels — instead of storing the current/target opacity for each symbol, we store it once per <code>crossTileID</code>. Then, at render time, we assign that opacity state to the “front-most” symbol, and assign the rest of the symbols the “invisible” opacity state [0,0].</p>
<p>Consider the “San Francisco” example, in which the label starts a 300ms fade-in while we are at zoom 10, and then we cross over into zoom 11 while the fade is still in progress.</p>
<ol>
<li>“San Francisco” at z10 is given <code>crossTileID</code> 12345. It starts fading in, so is given opacity state [0,1].</li>
<li>z11 tile loads, “San Francisco” is given ID 12345, but at render time given opacity [0,0]</li>
<li>After 150 ms collision detection runs and opacities are updated. 12345 opacity is updated to [.5,1]</li>
<li>z10 tile is unloaded. At this point z11 version of “San Francisco” is the front-most symbol for 12345, so it is rendered with [.5,1], allowing the fade-in animation to continue</li>
<li>After another 150ms, the fade in animation completes (without requiring any opacity updates)</li>
<li>After another 150ms, collision detection runs again and 12345’s opacity is updated to the “finished” state of [1,1].</li>
</ol>
<p>This opacity strategy also gives us a way to start showing the data from newly loaded tiles before we’ve had a chance to re-run the global collision detection algorithm with data from that tile: for symbols that share a cross-tile ID with an already existing symbol, we just pick up the pre-existing opacity state, while we assign all new cross-tile IDs an opacity state of [0,0]. The general effect while zooming in is that a tile will start showing with its most important POIs (the ones shared with the previous zoom level), and then some short period of time after the tile loads, the smaller POIs and road labels will start fading in.</p>
<p><strong>Detecting Duplicates</strong>
The <code>CrossTileSymbolIndex</code> is a collection of <code>CrossTileSymbolLayerIndex</code>es: duplicates can only exist within a single layer. Each <code>CrossTileSymbolLayerIndex</code> contains, for each integer zoom level, a map of tile coordinates to a <code>TileLayerIndex</code>. A <code>TileLayerIndex</code> represents all the symbols for a given layer and tile. It has a <code>findMatches</code> method that can identify symbols in its tile/layer that are duplicate with symbols in another tile/layer. The query logic is, for each symbol:</p>
<ol>
<li>If the query symbol is text, load the set of symbols that have the exact same text (often just one symbol). If the query symbol is an icon, load the set of all icons.</li>
<li>Convert the query symbol into “world coordinates” (see https://github.com/mapbox/hey/issues/6350) at the zoom level of the index. If the index is at z11 and the query symbol is at z10, the conversion essentially looks like a doubling of the query coordinates.</li>
<li>Reduce the precision of the coordinates — this is a type of rounding operation that allows us to detect “very close” coordinates as matches</li>
<li>For each local symbol, test if the scaled coordinates of the query are within a small “tolerance” limit of each other. If so, mark the query symbol as a duplicate by copying the <code>crossTileID</code> into it.</li>
</ol>
<p>The index is updated every time a tile is added to the render tree. On adding a tile, the algorithm is:</p>
<ol>
<li>Iterate over all children of the tile in the index, starting from the highest resolution zoom, and find any duplicates. Then, iterate over all parents of this tile, still in order of decreasing zoom. For each symbol in this tile, assign the first duplicate <code>crossTileID</code> you find.</li>
<li>For each symbol that didn’t get assigned a duplicate <code>crossTileID</code> create a new unique <code>crossTileID</code></li>
<li>Remove index entries for any tiles that have been removed from the render tree.</li>
</ol>
<p>A common operation is to replace a tile at one zoom level with a tile at a higher or lower zoom level. In many cases, the two tiles will both render simultaneously for some period before the old tile is removed, but it is also possible for there to be an instantaneous (i.e. single frame) swap between tiles in the render tree. In this case, an important property of the above algorithm is that the duplicate detection in step (1) happens <em>before</em> the unused tile pruning in step (3).</p>
<div style="break-before: page; page-break-before: always;"></div><p>(this article is mostly a stub)</p>
<p>Mapbox GL's threading structure is built around the concept of message passing. In GL JS, this is enforced by the WebWorker interface, while in gl-native we implement message passing using the <code>Actor</code> interface. In GL JS efficient transfer between threads requires serializing to raw <code>TypedArray</code>s, while in native we can simply transfer ownership of pointers. The relative difficulty of transferring ownership on the JS side leads to some architectural compromises (for instance, on native, any worker thread can pick up work on a tile, whereas on the JS side tiles are coupled to individual workers in order to hold onto intermediate state). Native also takes advantage of the <code>Immutable</code> pattern to allow read-only sharing between threads.</p>
<p>All versions of GL have a pool of &quot;workers&quot; that are primarily responsible for background tile generation, along with a &quot;render&quot; thread that continually renders the current state of the map using whatever tiles are currently available. On JS and iOS, the render thread is the same as the foreground/UI thread. For performance reasons, the Android render thread is separated from the UI thread -- changes to the map made on the UI thread are batched and sent to the render thread for processing. The platforms also introduce worker threads for various platform-specific tasks (for instance, running HTTP requests in the background), but in general the core code is agnostic about where those tasks get performed: it sends a request and runs a callback when it gets a response. The platform implementations of <code>CustomGeometrySource</code> currently run their own worker pools, but I think we should probably get rid of them: https://github.com/mapbox/mapbox-gl-native/issues/11895.</p>
<p>Each platform is required to provide its own implementation of concurrency/threading primitives for gl-core to use. The platform code outside of core is also free to use its own threading model (for instance, the iOS SDK uses Grand Central Dispatch for running asynchronous tasks).</p>
<h2 id="geometry-tile-worker"><a class="header" href="#geometry-tile-worker">Geometry Tile Worker</a></h2>
<p><img src="architecture/./geometrytileworker5.png" alt="geometrytileworker5" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="expression-architecture"><a class="header" href="#expression-architecture">Expression Architecture</a></h1>
<p>This document is meant to be an introduction to working with “expressions” in the Mapbox GL codebase. It uses gl-js examples, but the gl-native implementation is usually closely analogous (with a few layers of templating on top). I wasn’t very involved in the original design discussions, so this is mostly a distillation of what I’ve learned in the process of extending the expression language with the “collator” and “format” types. In my experience, the expression language itself is not as hard to understand as its embedding within the rest of the map.</p>
<h1 id="background"><a class="header" href="#background">Background</a></h1>
<p>Key Mapbox GL concepts from pre-expression days:</p>
<ul>
<li>“<strong>Layout</strong>” properties in the style spec are properties that are calculated at tile generation time, in the background. e.g.
'text-font': [&quot;DIN Office Pro&quot;, &quot;Arial Unicode MS&quot;]</li>
<li>“<strong>Paint</strong>” properties are calculated at render time, and can generally be updated much more quickly. Whether something is a paint or layout property often just depends on the implementation difficulty of calculating the property at run time. e.g.
'circle-radius': 20</li>
<li>There are monster hybrids, like <code>text-size</code>, which is a “layout” property but is also evaluated at render time.</li>
<li>“<strong>Data-Driven Styling (DDS)</strong>” This is the ability to generate layout and paint properties separately for each individual feature in a layer, based on (1) zoom and (2) feature properties.</li>
<li>“<strong>Run-Time Styling</strong>” The ability to change the style at run-time. Not directly relevant to expressions except that changes require re-evaluating expressions. Changes to paint properties can be made immediately, while changes to layout properties require re-parsing tiles.</li>
<li>“<strong>Function</strong>” This is the pre-expression syntax for DDS. “functions” exposed a fixed set of interpolation functions that could map input parameters to output parameters. Functions are still supported, but under the hood we simply convert them into equivalent general purpose “expressions”.  Example:
'circle-radius': {
property: 'population',
stops: [
[{zoom: 8, value: 0}, 0],
[{zoom: 8, value: 250}, 1],
[{zoom: 11, value: 0}, 0],
[{zoom: 11, value: 250}, 6],
[{zoom: 16, value: 0}, 0],
[{zoom: 16, value: 250}, 40]
]
}</li>
<li>“<strong>Layer</strong>” Know your “source layer” (this is a layer of data in a vector tile) from your “style layer” (this is a layer in the style sheet, you could also think of this as a “rendered” layer)</li>
<li>“<strong>Filter</strong>” A filter expresses rules for filtering features from a source layer to be included or excluded from a style layer. Before expressions, filters used their own mini-language in the style spec JSON. Pre-expression filters are now converted into expressions before being evaluated.</li>
<li>“<strong>Interpolation</strong>” We support linear, categorical, exponential, and cubic-bezier interpolation functions, both before and after expressions.</li>
<li>“<strong>Constant</strong>&quot; vs. “<strong>Zoom-Dependent</strong>” vs. “<strong>Property-Dependent</strong>” vs. “<strong>Zoom-and-Property-Dependent</strong>” Every property falls into one of these categories, both before and after expressions. Typically different code pathways are used for each category, with the most complex/expensive code pathway for zoom-and-property-dependent paint properties. In expression terms, you will see the equivalent <strong>isFeatureConstant</strong> or <strong>isZoomConstant</strong>, and also <strong>CameraExpression</strong> (zoom) <strong>SourceExpression</strong> (property), and <strong>CompositeExpression</strong> (zoom-and-property).</li>
<li>“<strong>Paint Property Binders</strong>&quot; These are a complex piece of <del>magic</del> logic that support rendering of property-dependent and zoom-and-property-dependent features within minimal render-time calculation. Hand-wavy, not-quite-accurate explanation: For each “bound” property (for example: <code>circle-radius</code>), and for each feature in the layer, there’s an entry recording the value for that feature evaluated at <code>tileZoom</code> and also evaluated at <code>tileZoom + 1</code>. At render time, an interpolation parameter is calculated based on the current zoom and the interpolation curve, and then passed to the shader.
<ul>
<li>This approach <strong>doesn’t change</strong> with expressions, which explains this limitation from the docs: “… in layout or paint properties, <code>[&quot;zoom&quot;]</code> may appear only as the input to an outer <code>[interpolate](https://www.mapbox.com/mapbox-gl-js/style-spec/#expressions-interpolate)</code>or <code>[step](https://www.mapbox.com/mapbox-gl-js/style-spec/#expressions-step)</code> expression, or such an expression within a <code>[let](https://www.mapbox.com/mapbox-gl-js/style-spec/#expressions-let)</code> expression.”</li>
<li>For more detail, see <code>program_configuration.js</code>, specifically the <code>Binder</code> interface</li>
</ul>
</li>
<li>“<strong>Tokens</strong>” e.g. <code>{name_en}</code>. The pre-expression way to refer to per-feature data in vector tiles. Before expressions, these could only be used in specialized contexts (like the <code>text-field</code> property). After expressions, tokens are automatically converted into “get” expressions, e.g. <code>[``&quot;``get``&quot;``,</code> <code>&quot;``name_en``&quot;``]</code>.</li>
</ul>
<h1 id="design-goals"><a class="header" href="#design-goals">Design Goals</a></h1>
<ul>
<li>Complete the work of DDS in exposing data in vector tiles as input for styling, without falling back to implementing one specialized “function” after another. The original name for this feature was “arbitrary expressions” — representing the alternative of implementing one expression at a time.
<ul>
<li>See https://github.com/mapbox/mapbox-gl-js/issues/4077 for some background</li>
</ul>
</li>
<li>Allow arbitrary logical and mathematical operations on per-feature data</li>
<li>Do <em>not</em> allow looping, turing-completeness, etc. The idea is to make a declarative language in which it should be relatively difficult to shoot yourself in the foot. We don’t want style authors to be able to make a layer whose cost to evaluate scales super-linearly with the number of features in the layer.</li>
<li>Can easily be extended with new “vocabulary” over time</li>
<li>Can be embedded in existing style spec</li>
<li>Can port all existing functionality to expressions</li>
<li>Minimal evaluation overhead</li>
</ul>
<p>The JSON/”lispy” syntax we went with satisfied the above goals, and had the attraction that the written form of expressions stayed close to the underlying AST. Our users are generally not excited about learning a new DSL to modify styling options — but one way to think of this is that the expression language itself can be a target of other, more appropriate DSLs. For example, on the iOS SDK, we wrap expressions in the platform-appropriate <code>[NSExpression](https://www.mapbox.com/ios-sdk/api/4.6.0/predicates-and-expressions.html)</code> <a href="https://www.mapbox.com/ios-sdk/api/4.6.0/predicates-and-expressions.html">syntax</a>. In Studio, we use <a href="https://github.com/mapbox/expression-jamsession">Jamsession</a> to make a simplified expression builder.</p>
<h1 id="implementation"><a class="header" href="#implementation">Implementation</a></h1>
<p>For each filter or property that uses an expression, we parse the raw JSON using a “parsing context” for that property. The result is a parsed expression tree, which is then embedded in a <code>PropertyValue</code>. At evaluation time, we provide an “evaluation context” and then evaluate the expression tree starting from the root. The result will be a constant value matching the property’s type.</p>
<h2 id="parsing"><a class="header" href="#parsing">Parsing</a></h2>
<p>The root of the parsing logic is in <code>parsing_context.js</code>. You start parsing with a mostly empty context (it contains information such as the expected type of the result, which is used in some automatic coercion logic). The first item in an expression array is the name (or “operator”) of the expression (e.g. <code>&quot;``concat``&quot;</code>). The parser looks up the <code>Expression</code>  implementation for that operator, and then hands parsing off to the class. Each implementation has its own logic for parsing children: if it accepts arguments that are themselves expressions, it will recurse into the root parsing logic, but with added context (for instance, expected types, bound <code>&quot;``let``&quot;</code> variables, etc.).</p>
<p><strong>CompoundExpression</strong>
Most expressions don’t need any special parsing rules beyond knowing their return type, their argument types, and any argument type overloads. All of these expressions are implemented using <code>CompoundExpression</code>. Example (from <code>definitions/index.js</code>):</p>
<pre><code>    '^': [
        NumberType,
        [NumberType, NumberType],
        (ctx, [b, e]) =&gt; Math.pow(b.evaluate(ctx), e.evaluate(ctx))
    ],
</code></pre>
<p>This says <code>&quot;``^``&quot;</code>  is an expression that returns a number, and it expects as arguments two expressions that return numbers (they could be constant expressions). The evaluator evaluates both child expressions, and then applies <code>Math.pow</code> to the results. <code>ctx</code> is the “evaluation context” getting passed through — a child expression might use it to know the current zoom level, or to look up a feature property, etc.</p>
<p><strong>Types, Assertions, and Coercions</strong>
The expression language has parse time and run-time type checking, based on this set of types:</p>
<pre><code>export type Type =
    NullTypeT |
    NumberTypeT |
    StringTypeT |
    BooleanTypeT |
    ColorTypeT |
    ObjectTypeT |
    ValueTypeT |
    ArrayType |
    ErrorTypeT |
    CollatorTypeT |
    FormattedTypeT
</code></pre>
<p>An <strong>assertion</strong> is a type of expression that allows you to give a return type to something that doesn’t have a type. So for instance <code>[``&quot;``get``&quot;``,</code> <code>&quot;``feature_property``&quot;``]</code> returns the generic <code>ValueType</code>, but if you want to pass it to an expression that requires a string argument, you can use an assertion: <code>[``&quot;``string``&quot;``, [``&quot;``get``&quot;``,</code> <code>&quot;``feature_property``&quot;``]]</code>. Assertions throw an evaluation-time error if the types don’t match during evaluation.</p>
<p>A <strong>coercion</strong> is a type of expression that allows you to convert return types. You can provide fallbacks in case coercion fails. e.g. <code>[``&quot;``to-number``&quot;``, [``&quot;``get``&quot;``,</code> <code>&quot;``feature_property``&quot;``], 0]</code>.</p>
<p>The initial implementation of the expression language erred on the side of requiring users to be explicit about types — for instance, <code>&quot;``get``&quot;</code> expressions very frequently had to be wrapped in assertions. In response to user feedbacks, we started building more “implicit” typing into the parsing engine. This is accomplished by automatically adding <code>Assertion</code> and <code>Coercion</code> expressions at parse time (they are called “annotations”). The basic rules are:</p>
<pre><code>// When we expect a number, string, boolean, or array but have a value, wrap it in an assertion.
// When we expect a color or formatted string, but have a string or value, wrap it in a coercion.
</code></pre>
<p><strong>Constant Folding</strong>
There’s not much compile-time optimization in expressions, but one thing we do at compile time whenever we parse a sub-expression, we check if it’s “constant” (i.e. it doesn’t depend on any evaluation context). If so, we evaluate the expression, and then replace it with a <code>Literal</code> expression containing the result of the evaluation.</p>
<h2 id="evaluation"><a class="header" href="#evaluation">Evaluation</a></h2>
<p>Evaluation is really pretty simple — you call “evaluate” on the root expression, it recurses, and eventually gives you back either a result or an error. The somewhat tricky part is the provided  <code>EvaluationContext</code>, which hooks the expression language up to actual data on the map. It contains:</p>
<ul>
<li><code>GlobalProperties</code>: global map state, like the current zoom level</li>
<li><code>Feature</code>: if this expression is being evaluated per-feature, this is the actual data for the feature from the underlying vector-tile</li>
<li><code>FeatureState</code>: Global “feature state” index, if necessary for this expression</li>
</ul>
<h2 id="property-propertyvalue-and-possiblyevaluatedvalue-oh-my"><a class="header" href="#property-propertyvalue-and-possiblyevaluatedvalue-oh-my">Property, PropertyValue, and PossiblyEvaluatedValue, oh my…</a></h2>
<p>This is technically outside the expression language, but understanding how style properties are hooked up to expressions is key to understanding how expressions are actually used. <code>properties.js</code> has lots of documentation! To start getting oriented:</p>
<ul>
<li><code>Property</code> refers to a property in the style specification. e.g. <code>'``circle-radius``'</code></li>
<li><code>PropertyValue</code> refers to the right hand-side of a property in the style <em>sheet</em>. e.g. <code>'``circle-radius``'``: 20</code>. It can be a constant value or an expression.</li>
<li><code>PossiblyEvaluatedValue</code> is all about not re-evaluating when you don’t need to. So if you have a “Property” that’s of type “DataDrivenProperty”, it will have a “PossiblyEvaluatedValue”. But for instance if that value is an expression and it’s “feature-constant”, then we can just store the value here and return it in future calls to <code>possiblyEvaluate</code> instead of continually re-evaluating the expression.</li>
</ul>
<h1 id="adding-a-new-expression"><a class="header" href="#adding-a-new-expression">Adding a New Expression</a></h1>
<p>Adding a new expression is actually pretty easy, as long as you don’t have to modify the type system. If it fits the parsing pattern of <code>CompoundExpression</code>, then you can just add it to the CompoundExpression registry, with a custom evaluation function. If not, well let’s see how to implement a “Foo” expression!</p>
<p>Register the operator in <code>definitions/index.js</code>:</p>
<pre><code>const expressions: ExpressionRegistry = {
    ...,
    'foo', FooExpression
  };
</code></pre>
<p>Create an implementation file at <code>definitions/foo.js</code>:</p>
<pre><code>export default class FooExpression implements Expression
</code></pre>
<p>Implement static <code>parse</code> logic that’s used to create instances of the expression:</p>
<pre><code>static parse(args: Array&lt;mixed&gt;, context: ParsingContext) {
    // Here's where you enforce syntax -- if type checking fails, you pass
    // the error back up the chain with context.error
    if (args.length !== 2)
        return context.error(`'foo' expression requires exactly one argument.`);

    if (!isValue(args[1]))
        return context.error(`invalid value`);

    const child = (args[1]: any);
    return new FooExpression(child);
}
</code></pre>
<p>Implement the <code>evaluate</code> method:</p>
<pre><code>evaluate(ctx: EvaluationContext) {
    // We don't use the context, but pass it through to our child
    return &quot;bar&quot; + this.child.evaluate(ctx);
}
</code></pre>
<p>Implement the <code>eachChild</code> method — this is necessary for various algorithms that traverse the expression tree:</p>
<pre><code>eachChild(fn: (Expression) =&gt; void) {
    fn(this.child);
}
</code></pre>
<p>Implement the <code>possibleOutputs</code> method — this is used to do a simple type of static analysis for expressions that have a finite number of possible outputs (for instance, if the top-level expression is a <code>&quot;``match``&quot;</code>  expression with three literal outputs, the only possible outputs are those three, no matter what goes on in the sub-expressions. Some properties are required to have a defined set of possible outputs (for instance <code>text-font</code>), because we need to be able to fetch them ahead of evaluation time. If your expression depends on external state, it could very easily have an infinite number of potential outputs, in which case simply return <code>[undefined]</code>.</p>
<pre><code>possibleOutputs() {
    // Cop-out!
    return [undefined];
}
</code></pre>
<p>Finally, implement the <code>serialize</code> method — this is basically the inverse of the <code>parse</code> method. The serialized result may not look identical to the original input that created an expression (because of changes like constant folding), but when evaluated it should give the same result (and in fact our test harness asserts that):</p>
<pre><code>serialize() {
    return [&quot;foo&quot;, this.child.serialize()];
}
</code></pre>
<p>You’re done! Although you should head straight over to <code>test/integration/expression-tests</code>, find an expression that’s similar to yours, copy its tests, and modify them to fit yours. An expression test has an:</p>
<ul>
<li>“expression”: of course</li>
<li>“inputs”: array of Feature/GlobalProperties pairs</li>
<li>“expected”
<ul>
<li>“compiled”: type information</li>
<li>“outputs”: evaluation results or errors</li>
<li>“serialized”: result of round-tripping the expression through parse/serialize</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gl-text-rendering-101"><a class="header" href="#gl-text-rendering-101">GL Text Rendering 101</a></h1>
<p>This document is intended as a high level architectural overview of the path from a <code>text-field</code> entry in a style specification to pixels on a screen. The primary audience is new maintainers or contributors to mapbox-gl-native and mapbox-gl-js, although it may also provide useful context for power users of Mapbox GL who want to know how the sausage is made.</p>
<p>Native and JS share very similar implementations, with occasionally different naming conventions. I will use them mostly interchangeably. For simplicity, I focus on text, but icons are a very close analog — for many purposes, you can think of an icon as just a label with a single “glyph”.</p>
<h2 id="motivation"><a class="header" href="#motivation">Motivation</a></h2>
<p>Why are we rolling our own text rendering in the first place, when browsers and operating systems already provide powerful text capabilities for free? Basically:</p>
<ul>
<li><strong>Control</strong>: To make beautiful interactive maps, we’re changing properties of the text in label on every frame
<ul>
<li>Size/scale</li>
<li>Relative positioning of glyphs (e.g. following a curved line)</li>
<li>Paint properties</li>
</ul>
</li>
<li><strong>Speed</strong>: If we asked the platform to draw the text for us and then uploaded the raster results to textures for rendering on the GPU, we’d have to re-upload a large amount of texture data for every new label, every change in size, etc. By rolling our own text rendering, we can take advantage of the GPU to efficiently re-use/re-combine small constituent parts (glyphs)</li>
</ul>
<p><em>Legible</em>, <em>fast</em>, and <em>beautiful</em> is the name of the game.</p>
<p>For some history on how this took shape, check out <a href="https://blog.mapbox.com/map-label-placement-in-mapbox-gl-c6f843a7caaa">Ansis' &quot;label placement&quot; blog post</a> from 2014 (many implementation details have changed, but the goals are the same).</p>
<h2 id="requesting-glyphs-text-field--text-font--glyphdependencies"><a class="header" href="#requesting-glyphs-text-field--text-font--glyphdependencies">Requesting glyphs: <code>text-field</code> + <code>text-font</code> → <code>GlyphDependencies</code></a></h2>
<p>Imagine a toy symbol:</p>
<pre><code>      &quot;layout&quot;: {
        &quot;text-field&quot;: &quot;Hey&quot;,
        &quot;text-font&quot;: [
          &quot;Open Sans Semibold&quot;,
          &quot;Arial Unicode MS Bold&quot;
        ]
      }
</code></pre>
<p>The <code>text-font</code> property is specified as a <strong>fontstack</strong>, which looks like an array of fonts, but from the point of view of GL is just a unique string that’s used for requesting glyph data from the server. Font compositing happens on the server and is totally opaque to GL.</p>
<p>At tile parsing time, the symbol parsing code builds up a <em>glyph dependency</em> map by evaluating <code>text-field</code> and <code>text-font</code> for all symbols in the tile and tracking unique glyphs:</p>
<pre><code>GlyphDependencies: {
 &quot;Open Sans Semibold, Arial Unicode MS Bold&quot;: ['H', 'e', 'y'],
 &quot;Open Sans Regular, Arial Unicode MS&quot;: ['t', 'h', 'e', 'r', 'e']
}
</code></pre>
<p>It’s worth noting here that our current code treats “glyph” and “unicode codepoint” interchangeably, although that assumption won’t always hold.</p>
<p>Once all the dependencies for a tile have been gathered, we send a <code>getGlyphs</code> message to the foreground, and wait for a response before moving on to symbol layout (unless the worker already has all the dependencies satisfied from an earlier request).</p>
<p><em>native</em></p>
<p><code>SymbolLayout</code> constructor: <a href="https://github.com/mapbox/mapbox-gl-native/blob/master/src/mbgl/layout/symbol_layout.cpp">symbol_layout.cpp</a></p>
<p><em>js</em></p>
<p><code>SymbolBucket#populate</code>: <a href="https://github.com/mapbox/mapbox-gl-js/blob/master/src/data/bucket/symbol_bucket.js">symbol_bucket.js</a></p>
<h2 id="glyphmanager"><a class="header" href="#glyphmanager">GlyphManager</a></h2>
<p>The <code>GlyphManager</code> lives on the foreground and its responsibility is responding to <code>getGlyphs</code> requests with an SDF bitmap and glyph metrics for every requested glyph. The GlyphManager maintains an in-memory cache, and if all the requested glyphs are already cached, it will return them immediately. If not, it will request them.</p>
<p><strong>Server Glyph Requests</strong>
Every style with text has a line like this:</p>
<p><code>&quot;glyphs&quot;: &quot;mapbox://fonts/mapbox/{fontstack}/{range}.pbf&quot;</code></p>
<p>This tells the GlyphManager where to request the fonts from (<code>mapbox://fonts/…</code> will resolve to something like <code>https://api.mapbox.com/…</code>). For each missing glyph, the GlyphManager will request a 256-glyph block containing that glyph. The server is responsible for providing the block of glyphs in a Protobuf-encoded format. Requests to api.mapbox.com (and probably most requests to custom-hosted font servers) are ultimately served by <a href="https://github.com/mapbox/node-fontnik">node-fontnik</a>.</p>
<p>When the response comes back over the network, the GlyphManager will upload all the glyphs in the block to its local cache (including ones that weren’t explicitly requested). Once all dependencies are satisfied, it will send a response back to the worker.</p>
<p><strong>Local Glyph Generation</strong>
The server request system above works pretty well for Latin scripts — usually there’s just one <code>0-255.pbf</code> request for every fontstack. But it’s a disaster for ideographic/CJK scripts. That’s why we implemented <a href="https://github.com/mapbox/mapbox-gl-native/wiki/local_glyph_generation">local CJK glyph generation</a>.</p>
<p>When local glyph generation is enabled, it’s the glyph manager who’s responsible for choosing whether to go to the server or generate locally, and the rest of the code doesn’t have to worry about it.</p>
<h2 id="glyphatlas"><a class="header" href="#glyphatlas">GlyphAtlas</a></h2>
<p>Once the worker receives glyph information from the foreground, it builds a <code>GlyphAtlas</code> out of every glyph that will be used on a tile. The glyph atlas is a single image that will be uploaded as a texture to the GPU along with the rest of the data for the tile. Here’s a visual representation of a glyph atlas:</p>
<p><img src="architecture/./glyphatlastexture.png" alt="GlyphAtlas texture" /></p>
<p>Once we’ve uploaded the glyph atlas to the GPU, we can represent each glyph we want to draw as two triangles, where the vertices encode both physical locations on the map but also a “lookup” location within the glyph atlas texture.</p>
<p><img src="architecture/./triangles" alt="Making a glyph out of two triangles" /></p>
<p>The raster format of the glyph is not a typical grayscale encoding — instead, it’s a “signed distance field” (SDF),  a raster format in which the value of each pixel encodes how far away it is from the “edge” of the glyph. SDFs make it easier for us to do things like dynamically resize text or draw “halos” behind text. For an in-depth description, read <a href="https://blog.mapbox.com/drawing-text-with-signed-distance-fields-in-mapbox-gl-b0933af6f817">Konstantin’s SDF devlog</a>.</p>
<h2 id="symbol-layout"><a class="header" href="#symbol-layout">Symbol Layout</a></h2>
<p>At the time we parsed the tile, we created one <code>SymbolBucket</code> for each set of symbol layers that shared the same layout properties (typically there is a 1:1 mapping between style layers and symbol buckets — but when two style layers differ only in their paint properties we share their layout work as an optimization). After parsing, the bucket contains a list of “features” that point into the raw vector tile data.</p>
<p>“Layout” is the process of turning those raw features into GL buffers ready for upload to the GPU, along with collision metadata (the <code>FeatureIndex</code>). The process starts by iterating over every feature, evaluating all of the style properties against that feature, and generating anchor points for the resulting symbol. Then we move on to shaping…</p>
<p><em>native</em></p>
<p><code>SymbolLayout::prepareSymbols</code>: <a href="https://github.com/mapbox/mapbox-gl-native/blob/master/src/mbgl/layout/symbol_layout.cpp">symbol_layout.cpp</a></p>
<p><em>js</em></p>
<p><code>performSymbolLayout</code>: <a href="https://github.com/mapbox/mapbox-gl-js/blob/master/src/symbol/symbol_layout.js">symbol_layout.js</a></p>
<h2 id="shaping"><a class="header" href="#shaping">Shaping</a></h2>
<p><em>Shaping</em> is the process of choosing how to position glyphs relative to each other. This can be a complicated process, but the basics are pretty simple — we start by placing our first glyph at some origin point, then we advance our “x” coordinate by the “advance” of the glyph, and place our second glyph. When we come to a line break, we reset our “x” coordinate and increment our “y” coordinate by the line height.</p>
<p><img src="architecture/./hey.gif" alt="Shaping &quot;Hey&quot;" /></p>
<p>We do shaping in a coordinate system that’s independent for each symbol — basically the positions are always <em>relative to the symbol anchor.</em> For <code>symbol-placement: point</code>, each glyph gets an “x” and “y” coordinate. For <code>symbol-placement: line</code>, we always lay out in a single line and essentially collapse to just “x” coordinates (at render time, we use the line geometry to calculate the actual position of each glyph).</p>
<p><strong>Line Breaking</strong>
The shaping code is responsible for determining where to insert line breaks. The algorithm we use tries to find a set of line breaks that will make all lines of a label have relatively similar length. For details on the algorithm (and why this is important for CJK labels), see <a href="https://blog.mapbox.com/beautifying-map-labels-with-better-line-breaking-2a6ce3ed432">my blog post on line-breaking</a>.</p>
<p><strong>BiDi and Arabic “Shaping”</strong>
The shaping code is also responsible for applying the Unicode Bidirectional algorithm to figure out how to interleave left-to-right and right-to-left text (it’s actually intertwined with line breaking). It’s actually <em>not</em> responsible for the thing we call “arabic shaping”, which is actually a codepoint substitution hack implemented in the earlier tile parsing stage. For more details, see <a href="https://blog.mapbox.com/improving-arabic-and-hebrew-text-in-map-labels-fd184cf5ebd1">my blog post on supprting Arabic text</a>.</p>
<p><strong>Vertical Text Layout</strong>
We have support for rotating CJK characters when they’re following a line that’s within 45 degrees of vertical. The way the implementation works is to run shaping twice: once in horizontal mode, and once in vertical mode (where CJK characters are rotated, but non-CJK characters aren’t). We upload both shapings to the GPU, and at render-time we dynamically calculate the orientation of each line label (based on current camera position), and based on that toggle which set of glyphs to hide/show.</p>
<p><strong>Variable Text Anchors</strong>
We’ve just added the ability for symbols to automatically change their anchor position to find a place to “fit” on the map. If changing the anchor may also require the text justification to change, we generate an extra shaping for each possible justification, and choose which set of glyphs at render time.</p>
<p><em>native</em></p>
<p><code>getShaping</code>: <a href="https://github.com/mapbox/mapbox-gl-native/blob/master/src/mbgl/text/shaping.cpp">shaping.cpp</a></p>
<p><em>js</em></p>
<p><code>shapeText</code>: <a href="https://github.com/mapbox/mapbox-gl-js/blob/master/src/symbol/shaping.js">shaping.js</a></p>
<h2 id="generating-quads"><a class="header" href="#generating-quads">Generating Quads</a></h2>
<p>The process of going from a <em>shaping</em> to GL buffers is pretty straightforward. It’s just a matter of taking each rectangular glyph from the shaping and turning it into two triangles (called a “quad”). We apply transforms like text rotation here, but essentially the way to think of it is just a translation between different in memory-representations of the same data.</p>
<p>After the buffers are generated, background work is essentially done, and we transfer all the buffers for our tile to the foreground, so it can start rendering.</p>
<p><em>native</em></p>
<p><a href="https://github.com/mapbox/mapbox-gl-native/blob/master/src/mbgl/text/quads.cpp">quads.cpp</a> and <code>SymbolLayout::addSymbol</code></p>
<p><em>js</em></p>
<p><a href="https://github.com/mapbox/mapbox-gl-js/blob/master/src/symbol/quads.js">quads.js</a> and <code>SymbolBucket::addSymbol</code></p>
<h2 id="the-foreground"><a class="header" href="#the-foreground">The Foreground</a></h2>
<p>All of the work up to this point happened in the background — if it takes longer to run, it means tiles take longer to load. Background work has to be fast relative to the cost of loading a tile from the network (or disk). If a tile can parse in 50ms, that’s fine. On the foreground, anything that takes more than a few millisecond will cause ugly, janky rendering.</p>
<p>Every 16ms, the render thread is responsible for drawing a frame with the contents of the currently loaded tiles. For symbols, this involves a few components:</p>
<ul>
<li>Collision detection (running every 300ms)</li>
<li>Per-layer CPU work (mainly updating line label positions)</li>
<li>Per-layer GPU draw calls (running the shaders)</li>
</ul>
<p>We originally did collision detection and line label layout on the background (along with the GPU), but despite the strict limits on render-thread CPU time, we moved them to the foreground over the course of 2017. Why?</p>
<ul>
<li>Each symbol instance comes from a specific tile, but symbols render across tile boundaries and can collide with each other across tile boundaries. Doing collision detection properly required global collision detection, and the foreground is the one place that has all the data available.</li>
<li>Text is way more legible laid out on the plane of the viewport, but background layout is necessarily done on the plane of the map, and the GPU has limited capability to re-do layout, since it has to handle each vertex in isolation from all the other vertices that make up a label.</li>
</ul>
<p>The cumulative effect of the &quot;pitched label quest&quot; of 2017 was a dramatic improvement in the legibility of our maps in pitched views:</p>
<div class="table-wrapper"><table><thead><tr><th>Before: gl-js v0.37, streets-v9</th><th>After: gl-js v0.42, streets-v10</th></tr></thead><tbody>
<tr><td><img src="https://d2mxuefqeaa7sj.cloudfront.net/s_00397E8FA07DA1FD4464A095484EEB163D04CB9AB03832D5F75B479455AAED2F_1507329463241_37rotation-loop.gif" alt="Before: gl-js v0.37, streets-v9" /></td><td><img src="https://d2mxuefqeaa7sj.cloudfront.net/s_00397E8FA07DA1FD4464A095484EEB163D04CB9AB03832D5F75B479455AAED2F_1507329463391_41rotation-loop.gif" alt="After: gl-js v0.42, streets-v10" /></td></tr>
</tbody></table>
</div>
<h2 id="basics-of-collision-detection-aka-placement"><a class="header" href="#basics-of-collision-detection-aka-placement">Basics of Collision Detection (aka “Placement”)</a></h2>
<p>To understand how our collision detection works, dig into <a href="https://github.com/mapbox/mapbox-gl-native/wiki/Collision-Detection">the Collision Detection article</a>.</p>
<p>The basic idea is that we represent each symbol as a box (for point labels) or as a series of circles (for line labels). When we run collision detection, we start with our highest priority feature, add its geometry to a 2D spatial index, and then move on to the next feature. As we go through each feature, we only add features that don’t collide with any already-placed features.</p>
<p><img src="https://camo.githubusercontent.com/f4638d61b45f9aa879945f2c42324f9f9a870c11/68747470733a2f2f64326d787565667165616137736a2e636c6f756466726f6e742e6e65742f735f303033393745384641303744413146443434363441303935343834454542313633443034434239414230333833324435463735423437393435354141454432465f313530373332373438323731335f53637265656e73686f742b323031372d31302d30362b31352e30342e32382e706e67" alt="After: Boxes (and for lines, circles) fit labels much more closely." /></p>
<p><strong>Fading</strong>
After collision detection finishes, we start fading in newly placed items and fading out newly collided items. We do this by uploading “opacity buffers” to the GPU for every symbol layer. For every symbol, we encode the current opacity and the “target” opacity (either 1 or 0). The shader then animates the fading by interpolating between “current” and “target” based on the global clock.</p>
<p><strong>CrossTileSymbolIndex</strong>
We use a data structure called the <code>CrossTileSymbolIndex</code> to identify symbols that are “the same” between different tiles (“same” ~ “similar position and same text value”). This is important for smooth zooming without symbols flickering in and out — instead of having to re-run collision detection whenever we load a new tile in order to figure out what we can show, we just match the symbols in the new tile against previously shown symbols, and if we find a match we use the same opacity information for the new symbol (until the next collision detection runs).</p>
<p><strong>Pauseable Placement</strong>
JS has a feature that splits collision detection across multiple frames, with a ~2ms limit for each frame. This adds complexity to the code, and on the native side we got acceptable performance without this feature, so we never implemented it.</p>
<p><strong>Symbol Querying</strong>
We have a long tradition of implementing new features and only when we think we’re finished realizing that we broke the <code>queryRenderedFeatures</code> functionality. Symbol querying is built on top of the <code>CollisionIndex</code> — we translate queries into the coordinates used by the collision index, get a list of symbols that intersect with the query coordinates, and then look up the data for the underlying features in the underlying (per-tile) <code>FeatureIndex</code>.</p>
<p><em>native</em></p>
<p><a href="https://github.com/mapbox/mapbox-gl-native/blob/master/src/mbgl/text/placement.cpp">placement.cpp</a> and <a href="https://github.com/mapbox/mapbox-gl-native/blob/master/src/mbgl/text/cross_tile_symbol_index.cpp">cross_tile_symbol_index.cpp</a></p>
<p><em>js</em></p>
<p><a href="https://github.com/mapbox/mapbox-gl-js/blob/master/src/symbol/placement.js">placement.js</a> and <a href="https://github.com/mapbox/mapbox-gl-js/blob/master/test/unit/symbol/cross_tile_symbol_index.js">cross_tile_symbol_index.js</a></p>
<h2 id="render-time-layout-for-line-labels"><a class="header" href="#render-time-layout-for-line-labels">Render-time layout for line labels</a></h2>
<p>Labels on curved lines in a pitched view are tricky. We want the glyphs to have consistent spacing in the viewport plane, but we want the glyphs to follow lines that are laid out in the tile plane, and the relationship between tile coordinates and viewport coordinates changes on every frame.</p>
<p>We brute-force the problem. For every line label, we transfer not only its glyphs to the foreground, but also the geometry of the line that it’s laid out on. At render time, we start at the anchor point for the label, and figure out where the ends of that line segment end up in viewport space. If there’s enough space for the label, we lay it out along that projected line. Otherwise, we keep moving outward, one line segment at a time, until there’s enough room for the whole label, and for each glyph we calculate x/y coordinates based on where it fits on the projected lines. Then, we upload all of this layout data to the GPU before drawing.</p>
<p>This is expensive! On dense city maps, it shows up as our biggest render-thread expense. But it also looks good.</p>
<p><img src="https://d2mxuefqeaa7sj.cloudfront.net/s_803C84E0CA016986191C4CE0FF80AB67E20CD59635751C941625C4E103CA2401_1548441245916_image.png" alt="" /></p>
<p>We also use this render-time line projection logic to determine which “collision circles” should be used for a label (as you pitch the map, vertically oriented labels essentially get “longer”, so they need to use more collision circles). It’s a historical accident that we create these collision circles on the background and then dynamically choose which ones to use on the foreground — if we were starting fresh, we would just generate the collision circles on the foreground.</p>
<p><em>native</em></p>
<p>See <code>reprojectLineLabels</code> in <a href="https://github.com/mapbox/mapbox-gl-native/blob/master/src/mbgl/renderer/layers/render_symbol_layer.cp">render_symbol_layer.cpp</a></p>
<p><em>js</em></p>
<p>See <code>symbolProjection.updateLineLabels</code> in <a href="https://github.com/mapbox/mapbox-gl-js/blob/master/src/render/draw_symbol.js">draw_symbol.js</a></p>
<h2 id="perspective-scaling"><a class="header" href="#perspective-scaling">Perspective Scaling</a></h2>
<p>What’s up with this formula: <code>0.5 + 0.5 * camera_to_center / camera_to_anchor</code>?</p>
<p>It’s a technique for making far-away text somewhat easier to read, and to keep nearby text from taking up too much space. After a lot of prototyping and over-design, Nicki and I decided on a simple rule: “all text in pitched maps should scale at 50% of the rate of the features around it”. So if your label is over a lake in the distance that is drawn at 25% of the size it would be in the center of the map, your text should be drawn at 50% of the size it would be in the center of the map.</p>
<p>In the formula, “camera to center” is the distance (don’t worry about the units, although they’re kind of pixel-based) to the point in the center of the viewport. This is a function of the viewport height and the field of view. “camera to anchor” is the distance to the anchor point of a symbol, in the same units. In an un-pitched map, “camera to anchor” is the same as “camera to center” for every point (if you think about this, it’s not actually the same as if you were staring down at a paper map flat on the table!).</p>
<div class="table-wrapper"><table><thead><tr><th>Before: Dense, hard-to-read labels in the distance</th><th>After: Fewer but larger labels in the distance</th></tr></thead><tbody>
<tr><td><img src="https://d2mxuefqeaa7sj.cloudfront.net/s_00397E8FA07DA1FD4464A095484EEB163D04CB9AB03832D5F75B479455AAED2F_1507324103175_Screenshot+2017-10-06+14.07.35.png" alt="Before: Dense, hard-to-read labels in the distance" /></td><td><img src="https://d2mxuefqeaa7sj.cloudfront.net/s_00397E8FA07DA1FD4464A095484EEB163D04CB9AB03832D5F75B479455AAED2F_1507324103164_Screenshot+2017-10-06+14.08.01.png" alt="After: Fewer but larger labels in the distance" /></td></tr>
</tbody></table>
</div>
<h2 id="units-planes-and-projections"><a class="header" href="#units-planes-and-projections">Units, planes, and projections</a></h2>
<p>Understanding or modifying text code requires a firm grasp of the units involved, and it’s easy to lose track of which you’re working with:</p>
<ul>
<li><strong>point</strong> The internal unit of glyph metrics and shaping
<ul>
<li>Converted to pixels in shader by <code>fontScale</code></li>
</ul>
</li>
<li><strong>em</strong> For us, an “em” is always 24 points.
<ul>
<li>When we generate SDFs, we always draw them with a 24 point font. We then scale the glyph based on the <code>text-size</code> (so a 16 point glyph for us is just 2/3 the size of the 24 point glyph, whereas the underlying font might actually use different glyphs at smaller sizes)</li>
<li>Commonly used for text-related style spec properties</li>
<li>https://en.wikipedia.org/wiki/Em_(typography)</li>
</ul>
</li>
<li><strong>pixel</strong> Self explanatory, right?
<ul>
<li>Except these are kind of “imaginary” pixels. Watch out for properties that are specified in pixels but are laid out in tile-space. In that case we may transform them to something that’s not literally a pixel on screen</li>
<li>See <code>pixelsToGLUnits</code> and <code>pixelsToTileUnits</code></li>
</ul>
</li>
<li><strong>tile unit</strong> value between 0 and tile EXTENT (normalized to 8192 regardless of extent of source tile)
<ul>
<li>This is the basic unit for <em>almost</em> everything that gets put in a GL buffer. The transform form a tile converts tile units into positions on screen.</li>
<li>Assuming 512 pixel tile size and 8192 EXTENT, each tile unit is 1/16 pixel when the tile is shown at its base zoom and unpitched. See <code>pixelsToTileUnits</code> for conversion logic at fractional zoom, and of course in pitched maps there’s no direct linear conversion.</li>
</ul>
</li>
<li><strong>gl coordinates/NDC</strong> [-1, 1] coordinates based on the viewport
<ul>
<li>NDC or “normalized” form is just gl-coord x,y,z divided by the “w” component.</li>
<li><code>u_extrude_scale</code> is typically used in the shaders to convert into gl units</li>
</ul>
</li>
</ul>
<p>When you modify a point, you always want to use units that match the coordinate space that you’re currently working in. “Projection” transform points from one coordinate space to the next.</p>
<ul>
<li><strong>Tile coordinate space</strong>
<ul>
<li>Use tile units</li>
<li>Different tiles have different coordinates, but they’re all in the “plane” of the map (that is, the potentially-pitched “surface”)</li>
</ul>
</li>
<li><strong>Map pixel coordinate space</strong>
<ul>
<li>Use pixel units</li>
<li>Transformed from tile units to pixels, but still aligned to the map plane. May be rotated</li>
</ul>
</li>
<li><strong>Viewport pixel coordinate space</strong>
<ul>
<li>Use pixel units</li>
<li>Aligned to viewport (e.g. “flat” relative to viewer)</li>
</ul>
</li>
<li><strong>GL coordinate space</strong>
<ul>
<li>Use gl units</li>
<li>Aligned to viewport</li>
</ul>
</li>
</ul>
<p>In the text rendering code, the <code>labelPlaneMatrix</code> takes you from tile units to the “label plane” (the plane on which your text is drawn), and then the <code>glCoordMatrix</code> takes you from the label plane to the final <code>gl_Position</code> output. The order of projection depends on what you’re drawing — the two most common cases are:</p>
<ul>
<li>Viewport-aligned line labels: use <code>labelPlaneMatrix</code> to project to viewport-pixel coordinate space in CPU, do layout, pass “identity” <code>labelPlaneMatrix</code> to shader, then apply <code>glCoordMatrix</code> in shader.</li>
<li>Viewport-aligned point labels: pass tile→viewport-pixel <code>labelPlaneMatrix</code> to shader, which applies projection, does pixel-based layout, then projects to GL coords.</li>
</ul>
<p>For more details on the coordinate systems, see the comments at the header of: <a href="https://github.com/mapbox/mapbox-gl-js/blob/master/src/symbol/projection.js">projection.js</a></p>
<p><img src="https://camo.githubusercontent.com/ce0887db54be49be6b2a12abc45ec2ee2b170335/68747470733a2f2f64326d787565667165616137736a2e636c6f756466726f6e742e6e65742f735f303234304346304338433645414534434533453530453344464546383235453232333843363132364245374142394231433646313431413638393739363035425f313439373536343031333931345f57617368696e67746f6e2b4d6f6e756d656e742b53637265656e2b436f6f7264696e617465732e706e67" alt="cat coordinates" /></p>
<p>For a more detailed walk-through of how we transform points, see <a href="https://github.com/mapbox/mapbox-gl-native/wiki/Coordinate-Systems">Mapbox GL coordinate systems</a>. Or, just to develop an intuition, play with <a href="https://chrisloer.github.io/mapbox-gl-coordinates">this interactive demo</a>.</p>
<h2 id="how-to-love-the-symbol_sdf-shader"><a class="header" href="#how-to-love-the-symbol_sdf-shader">How to love the <code>symbol_sdf</code> shader</a></h2>
<p>Phew, we’re finally at the point where something gets drawn on the screen!</p>
<p><strong>Vertex Shader</strong>
The vertex shader is responsible for figuring out where the outer edges of each glyph quad go on the screen. Its input is basically: an anchor, an offset, and a bunch of sizing/projection information. </p>
<p>There are a few steps:</p>
<ul>
<li>Figuring out the “size”
<ul>
<li>works differently depending on whether the property is zoom or feature-dependent</li>
</ul>
</li>
<li>Figuring out the “perspective ratio”
<ul>
<li>Based on projecting <code>a_pos</code>, which is the anchor for the symbol as a whole. Easy to confuse with <code>a_projected_pos</code>, which in the case of line labels can be the CPU-projected position of a single glyph (while in the case of point labels it’s the same as <code>a_pos</code>).</li>
</ul>
</li>
<li>Offsetting the vertex from the label-plane <code>projected_pos</code>, including rotation as necessary</li>
<li>Calculating opacity to pass to fragment shader</li>
<li>Projecting to gl coordinates, passing texture coordinates to fragment shader</li>
</ul>
<p><strong>Fragment Shader</strong>
The fragment shader is given a position within the glyph atlas texture, looks it up, and then converts it into a pixel value:</p>
<p><code>alpha = smoothstep(buff - gamma_scaled, buff + gamma_scaled, dist);</code></p>
<p>👆 <code>dist</code> is the “signed distance” we pull out of the texture. <code>buff</code> is basically the boundary between “inside the glyph” and “outside the glyph” (dirty secret: we call them “signed distance field”, but we actually encode them as uint8s and treat 192-255 as “negative”). <code>gamma_scaled</code> defines the distance range we use to go from alpha 255 to alpha 0 (so we get smooth diagonal edges).</p>
<p>The fragment shader also applies paint properties in a fairly obvious way.</p>
<p><strong>Icons</strong>
The astute will note that <code>symbol_icon</code> has a nearly-identical vertex shader, while its fragment shader does lookup in an RGBA texture instead of an SDF. The wise will also know that GL supports uploading SDF icons, so sometimes icons are actually rendered with <code>symbol_sdf</code>.</p>
<h2 id="tada-"><a class="header" href="#tada-">Tada! 🎉</a></h2>
<p><img src="https://d2mxuefqeaa7sj.cloudfront.net/s_803C84E0CA016986191C4CE0FF80AB67E20CD59635751C941625C4E103CA2401_1548461087521_image.png" alt="" /></p>
<p>Aww… crap. When something doesn’t work in the shader, you’re <em>lucky</em> if the result is this 👆 legible. You can’t debug directly in the shader, so how can you tell what’s going wrong?</p>
<ul>
<li>Check your units!</li>
<li>Pause right before the call to <code>gl_drawElements</code>, examine all the inputs, and try simulating the shader code by hand with pen and paper for one or two vertices. This is fun and doing it regularly will probably reduce your risk of getting dementia when you’re older.</li>
<li>Use an OpenGL debugger (such as WebGL Inspector extension in Chrome) to capture all the draw calls going into a frame. This is good for eyeballing things like “what’s in the texture I just uploaded”. You can also use it to look at the contents of the buffers being used in the draw call, although in my experience it’s easier to inspect them on the CPU side.</li>
<li>Write debugging code in the shader — the tricky thing is getting creative with figuring out how to extract debug information by drawing it onscreen. The “overdraw inspector” is a simple but very useful example of this approach.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mapbox-gl-coordinate-systems"><a class="header" href="#mapbox-gl-coordinate-systems">Mapbox GL Coordinate Systems</a></h1>
<blockquote>
<p><strong>TL;DR:</strong> Unsure how a point on a map gets transformed from a WGS84 latitude/longitude into x and y coordinates of a pixel on your screen? <del>Love matrix math</del> Willing to skim past a bunch of math? Read on… </p>
<p>Just want to see some of the guts of Mapbox GL without any context? Check out the <a href="https://chrisloer.github.io/mapbox-gl-coordinates">coordinate transformation demo I made</a></p>
</blockquote>
<p>For the last two months, I've been working on <a href="https://github.com/mapbox/mapbox-gl-js/pull/4547">making labels easier to read on pitched maps</a>, and as my first time really working with 3D graphics, it's been a crash course in trigonometry and linear algebra. The work brought back a surprising number of pleasant memories from high school trig class, and made me grateful for all the teachers (from Mr. Hatter twenty years ago to our local math teacher <a href="https://github.com/anandthakker">@anandthakker</a> today) who have worked to prepare me for this job!</p>
<p>3D graphics are <a href="https://learnopengl.com/#!Getting-started/Coordinate-Systems">all about transforming points between different coordinate systems</a>, and as I followed our code to figure out how our transformations worked, I kept getting tripped up because I didn't realize which coordinate system the code was using. In this devlog, I'm trying to answer the question I didn't know I needed to ask when I started: what coordinate systems do we use in Mapbox GL to turn a bunch of points defined by latitude and longitude into a bunch of points with pixel x and y coordinates on your screen?</p>
<p>If you’re working directly on Mapbox GL code, this is important stuff to know: otherwise, these implementation details are for the most part mercifully hidden.</p>
<p>I'll start where @lyzidiamond's <a href="https://github.com/mapbox/hey/issues/6314">awesome devlog on projections and coordinate systems</a> left off: WGS84 latitude and longitude.</p>
<h2 id="wheres-the-washington-monument"><a class="header" href="#wheres-the-washington-monument">Where's the Washington Monument?</a></h2>
<p>Let's follow how one point gets transformed through our different coordinate systems. The Washington Monument is located at approximately <code>(longitude: -77.035915, latitude: 38.889814)</code> in the WGS84 coordinate system. What happens if we ask Mapbox GL to draw a cat at just that point?</p>
<p><img src="rendering/./google-made-this-easy.jpg" alt="google made this easy" /></p>
<p>There are five coordinate systems we'll move through:</p>
<ul>
<li>WGS84</li>
<li>World Coordinates</li>
<li>Tile Coordinates</li>
<li>GL Coordinates</li>
<li>Screen Coordinates/NDC</li>
</ul>
<p><strong>Projecting WGS84 to Web Mercator/&quot;World Coordinates&quot;</strong>
As <a href="https://github.com/lyzidiamond">@lyzidiamond</a> pointed out, computers love squares, so our first step is to take those spherical coordinates and turn them into coordinates on a rectangular 2D world (aka a &quot;Pseudo-Mercator Projection&quot;). Our particular projection imagines the world as a giant grid of pixels with the size:</p>
<pre><code>worldSize = tileSize * number of tiles across one dimension
</code></pre>
<p>We use a tile size of <code>512</code> (roughly: this means a tile is 512 pixels square, although that would only be true at the base zoom level and without any pitch). I'll assume we're rendering tiles at zoom level <code>11</code> (which means there are <code>2^11</code> tile positions across both dimensions). That gives us:</p>
<pre><code>worldSize = 512 * 2^11 = 1048576
</code></pre>
<p>Then getting an x coordinate is easy, we just shift by 180˚ (because we start with x=0 at -180˚) and multiply by the world size:</p>
<pre><code>x coord = (180˚ + longitude) / 360˚ * worldSize 
        = (180˚ + -77.035915˚) / 360˚ * 1048576
        = 299,904
</code></pre>
<p>For the y coordinate, we apply the <a href="https://en.wikipedia.org/wiki/Web_Mercator">funky y stretch that is Web Mercator</a>:</p>
<pre><code>y = ln(tan(45˚ + latitude / 2))
  = ln(tan(45˚ + 38.889814˚ / 2))
  = 0.73781742861
y coord = (180˚ - y * (180 / π)) / 360˚ * worldSize
        = (180˚ - 42.27382˚) / 360˚ * 1048576
        = 401,156
</code></pre>
<p>OK, so <code>(x: 299904, y: 401156)</code> may be a great internal representation, but it's awkward and you have to know what zoom level it applies to. We can represent the same world coordinate by storing the zoom level and dividing the x and y components by the tile size. Our Washington Monument coordinate then becomes: <code>(585.7471, 783.5067, z11)</code>. One nice thing about storing coordinates this way is that it's really simple to transform them to different zoom levels.</p>
<p><img src="https://d2mxuefqeaa7sj.cloudfront.net/s_0240CF0C8C6EAE4CE3E50E3DFEF825E2238C6126BE7AB9B1C6F141A68979605B_1497564253787_Washington+Monument+World+Coordinates.png" alt="world coordinates" /></p>
<p><strong>Web Mercator -&gt; Tile Coordinates</strong>
Now we're making progress, because we have almost exactly what we need to ask the server for a tile that contains this point: we just drop the sub-integer precision and ask for <code>(585/783/11)</code>.</p>
<p>If we're drawing a vector tile, it will have geometry data for all the things on the map that we need to draw <em>around</em> our Washington Monument Cat. The <a href="https://github.com/mapbox/vector-tile-spec/tree/master/2.1#41-layers">Mapbox vector tile spec</a> specifies that tiles should have a defined <code>extent</code> that they use internally for coordinates. For a tile with an <code>extent</code> of 1024, <code>(0,0)</code> would be the top left corner of the tile and <code>(1024,1024)</code> would be on the bottom right.</p>
<p>Whatever tile coordinates come in, Mapbox GL internally normalizes to an <code>extent</code> of 8192 — since our tiles are (kind of) 512 pixels wide, that means our tile coordinates have a precision of 512/8192 = 1/16th of a pixel. To represent our Washington Monument coordinates in tile coordinates, we just multiply the remainder by the extent, so:</p>
<pre><code>(x: 585.7471, y: 783.5067, zoom: 11)
</code></pre>
<p>Becomes:</p>
<pre><code>Tile: 585/783/11
Tile Coordinates: (.7471 * 8192, .5067 * 8192) = (x: 6120, y: 4151)
</code></pre>
<p><img src="https://d2mxuefqeaa7sj.cloudfront.net/s_0240CF0C8C6EAE4CE3E50E3DFEF825E2238C6126BE7AB9B1C6F141A68979605B_1497564323856_Washington+Monument+Tile+Coordinates.png" alt="tile coordinates" /></p>
<p><strong>Tile Coordinates -&gt; 4D GL Coordinates</strong>
When Mapbox GL loads a map tile, it pulls together all the data for the tile and turns it into a representation the GPU can understand. In general, the representation we give to the GPU is specified in tile coordinates — the advantage here is that we only have to build the tile once, but then we can ask the GPU to quickly draw the same tile with different bearing, pitch, zoom, and pan parameters.</p>
<p>The code we have that runs on the GPU is called a &quot;shader&quot;: it takes tile coordinate inputs and outputs four dimensional &quot;GL Coordinates&quot; in the form <code>(x, y, z, w)</code>. Wait, four dimensions? Don't worry, it's just for doing math.</p>
<p><code>x</code> and <code>y</code> are pretty straightforward left/right and up/down. <code>z</code> is only slightly trickier: it represents position along an axis directly orthogonal to your screen. <code>w</code> is the more mysterious component, but it's necessary for generating the &quot;perspective&quot; effect: you can think of it as a &quot;scaling&quot; parameter for the other components, or as a measure of how far away they are from the viewer. When we draw labels, it's very useful to know the <code>w</code> component of a point, because it gives us a measure of how large the items around us will be (a higher <code>w</code> value means the perspective projection will make everything around our point smaller when it ultimately displays on the screen).</p>
<p>Converting from tile coordinates to GL coordinates involves applying a lot of &quot;transformations&quot; to the coordinates: one to apply perspective, one to move the imaginary camera away from the map, one to center the map, one to rotate the map, one to pitch the map, etc. Each one of these transformations can be represented as a 4D matrix, and all of the matrices can be combined into one matrix that applies all the transformations in one mathematical operation. These transformations build on top of some pixel-based parameters (size of the viewport, idealized size of tile) so we sometimes talk about the resulting coordinates as &quot;pixel&quot; coordinates although it's a fairly indirect connection. You might also see this coordinate system referred to as <a href="https://en.wikipedia.org/wiki/Clip_coordinates">&quot;clip space&quot;</a>.</p>
<p>Let's see what that looks like for a very specific view of our map. Note that each tile has its own projection matrix: before going into GL coordinates, we first have to go back from tile coordinates to world coordinates so that the points from different tiles all have the same frame of reference.</p>
<pre><code>Zoom level: 11.6
Map Center: 38.891/-77.0822 (over Washington DC)
Bearing: -23.2 degrees
Pitch: 45 degrees
Viewport dimensions: 862 by 742 pixels
Tile: 585/783/11 (covering a portion of Washington DC)
</code></pre>
<p>Gives a transformation matrix of:</p>
<div class="table-wrapper"><table><thead><tr><th></th><th>x</th><th>y</th><th>z</th><th>w</th></tr></thead><tbody>
<tr><td>x</td><td>0.224</td><td>-0.079</td><td>-0.026</td><td>-0.026</td></tr>
<tr><td>y</td><td>-0.096</td><td>-0.184</td><td>-0.062</td><td>-0.061</td></tr>
<tr><td>z</td><td>0.000</td><td>0.108</td><td>-0.036</td><td>-0.036</td></tr>
<tr><td>w</td><td>-503.244</td><td>1071.633</td><td>1469.955</td><td>1470.211</td></tr>
</tbody></table>
</div>
<p>There's way too much to unpack there in one devlog, but if you want to look at all the individual transformations to get a feel for how they fit together to make a 3D projection, and how they change as you move around the map, check out this <a href="https://chrisloer.github.io/mapbox-gl-coordinates">GL coordinate transformation demo I made</a>.</p>
<p>To get from tile coordinates to GL coordinates, we just turn the tile coordinates into a 4D vector with a z-value of 0 (ignoring buildings for now, sorry <a href="https://github.com/lbud">@lbud</a>!) and &quot;neutral&quot; w-value of 1. We then <a href="https://en.wikipedia.org/wiki/Transformation_matrix">apply the transformation matrix</a> to get our GL coordinate, so:</p>
<pre><code>(x: 6120, y: 4151, z: 0, w: 1)
</code></pre>
<p>Becomes:</p>
<div class="table-wrapper"><table><thead><tr><th></th><th>x</th><th>y</th><th>z</th><th>w</th></tr></thead><tbody>
<tr><td>input x = 6120</td><td>0.224 * 6120 = 1370.88</td><td>-0.079 * 6120 = -483.48</td><td>-0.026 * 6120 = -159.12</td><td>-0.026 * 6120 = -159.12</td></tr>
<tr><td>input y = 4151</td><td>-0.096 * 4151 = -398.496</td><td>-0.184 * 4151 = -763.784</td><td>-0.062 * 4151 = -257.362</td><td>-0.061 * 4151 = 253.311</td></tr>
<tr><td>input z = 0</td><td>0.000 * 0 = 0</td><td>0.108 * 0 = 0</td><td>-0.036 * 0 = 0</td><td>-0.036 * 0 = 0</td></tr>
<tr><td>input w = 1</td><td>-503.244 * 1 = -503.244</td><td>1071.633 * 1 = 1071.633</td><td>1469.955 * 1 = 1469.955</td><td>1470.211 * 1 = 1470.211</td></tr>
<tr><td><strong>Output (Summed)</strong></td><td>469.14</td><td>-175.631</td><td>1053.473</td><td>1057.78</td></tr>
</tbody></table>
</div>
<p>😬 (yikes, the numbers don’t exactly match up with the machine output below! My excuse is that I did the math by hand at low precision…)</p>
<pre><code>(x: 472.1721, y: -177.8471, z: 1052.9670, w: 1053.7176)
</code></pre>
<p><img src="https://d2mxuefqeaa7sj.cloudfront.net/s_0240CF0C8C6EAE4CE3E50E3DFEF825E2238C6126BE7AB9B1C6F141A68979605B_1497564431838_Washington+Monument+GL+Coordinates.png" alt="gl coordinates" /></p>
<p>When you pan/rotate/tilt our map and it animates at a smooth 60 fps, what's happening is that we're changing the transformation matrix and then passing that modified matrix to the GPU, which does a massively parallel (and mind-bogglingly fast) application of that transformation matrix to all the points it needs to draw.</p>
<p><strong>4D GL Coordinates -&gt; 2D Pixels on your screen</strong>
Our shader code is done once it outputs GL Coordinates, but OpenGL still does some more work to turn the coordinates into pixel locations on your screen.</p>
<p>First, it transforms to &quot;Normalized Device Coordinates&quot; by dividing the <code>x, y, z</code> components of the GL Coordinate by the <code>w</code> component. The resulting values look like:</p>
<pre><code>x: -1,1 --&gt; left to right of viewport
y: -1,1 --&gt; bottom to top of viewport
z: -1,1 --&gt; depth (not directly visible)
</code></pre>
<p>Any values outside of the range <code>[-1,1]</code> indicate points that are off the screen — they are (kind of) thrown away. You can see that another way to think of <code>w</code> is as &quot;the bounds of what coordinates are visible at this distance&quot;.</p>
<p>In our example, the GL Coordinates:</p>
<pre><code>     (x: 472.1721, y: -177.8471, z: 1052.9670, w: 1053.7176)
</code></pre>
<p>Become NDC:</p>
<pre><code>        (472.1721 / 1053.72, -177.8471 / 1053.72, 1052.9670 / 1053.72)
     -&gt; (x: 0.4481, y: -0.1688, z: 0.9993)
</code></pre>
<p>The z-value of NDC doesn't affect the 2D pixel coordinates. Instead, it's used for combining multiple layers (for instance, a bridge drawn over a river). The z-value tells the GPU which points are &quot;in front&quot; of other points: for opaque layers only the frontmost layer will show, but for translucent layers the z-order can be used for blending. Actually, I don't really know what I'm talking about here: ask <a href="https://github.com/lbud">@lbud</a>!</p>
<p>Finally, OpenGL translates NDC to pixel coordinates based on the size of the viewport:</p>
<p><img src="https://d2mxuefqeaa7sj.cloudfront.net/s_0240CF0C8C6EAE4CE3E50E3DFEF825E2238C6126BE7AB9B1C6F141A68979605B_1497630299136_NDC+Sketch.jpg" alt="NDC to pixel" /></p>
<p>In our case, the viewport is 862x742 pixels, so:</p>
<pre><code> Pixel Coordinates: (NDC.x * width + width / 2, height / 2 - NDC.y * height)
                  = (0.4481 * 862 + 431, 371 - (-0.1688 * 742))
                  = (x: 624, y: 434)
</code></pre>
<p>🎉 </p>
<p><img src="https://d2mxuefqeaa7sj.cloudfront.net/s_0240CF0C8C6EAE4CE3E50E3DFEF825E2238C6126BE7AB9B1C6F141A68979605B_1497564013914_Washington+Monument+Screen+Coordinates.png" alt="screen coordinates" /></p>
<div style="break-before: page; page-break-before: always;"></div><ul>
<li><strong>Mali Performance series</strong>
<ul>
<li><a href="https://community.arm.com/graphics/b/blog/posts/mali-performance-1-checking-the-pipeline">1: Checking the Pipeline</a></li>
<li><a href="https://community.arm.com/graphics/b/blog/posts/mali-performance-2-how-to-correctly-handle-framebuffers">2: How to Correctly Handle Framebuffers</a></li>
<li><a href="https://community.arm.com/graphics/b/blog/posts/mali-performance-3-is-egl_5f00_buffer_5f00_preserved-a-good-thing">3: Is <code>EGL_BUFFER_PRESERVED</code> a good thing?</a></li>
<li><a href="https://community.arm.com/graphics/b/blog/posts/mali-performance-4-principles-of-high-performance-rendering">4: Principles of High Performance Rendering</a></li>
<li><a href="https://community.arm.com/graphics/b/blog/posts/mali-performance-5-an-application-s-performance-responsibilities">5: An Application's Performance Responsibilities</a></li>
<li><a href="https://community.arm.com/graphics/b/blog/posts/mali-performance-6-efficiently-updating-dynamic-resources">6: Efficiently Updating Dynamic Resources</a></li>
<li><a href="https://community.arm.com/graphics/b/blog/posts/mali-performance-7-accelerating-2d-rendering-using-opengl-es">7: Accelerating 2D rendering using OpenGL ES</a></li>
</ul>
</li>
<li><a href="https://developer.arm.com/-/media/Files/pdf/graphics-and-multimedia/Guides/DUI0555C_mali_optimization_guide.pdf">Mali GPU Application Optimization Guide</a></li>
<li><a href="https://developer.arm.com/graphics/tutorials/performance-and-optimization-tutorials">ARM/Mali Performance and Optimization Tutorials</a></li>
<li><a href="https://web.archive.org/web/20160316190830/https://developer.qualcomm.com/qfile/28557/80-nu141-1_b_adreno_opengl_es_developer_guide.pdf">Adreno OpenGL ES Developer Guide</a></li>
<li><a href="https://wiki.mozilla.org/Platform/GFX/MobileGPUs">Mozilla list of Mobile GPU optimization</a> (older)</li>
<li><a href="https://web.archive.org/web/20170507011928/https://developer.oculus.com/blog/carmacks-critiques-graphics-optimization-for-gear-vr/">Optimizations for Tile based deferred GPUs</a></li>
<li><a href="https://community.imgtec.com/?do-download=powervr-performance-recommendations">PowerVR Performance Recommendations</a></li>
<li><a href="https://web.archive.org/web/20140831022302/https://community.imgtec.com/developers/powervr/presentations/">PowerVR Presentations</a></li>
<li><a href="https://web.archive.org/web/20140618214946/https://community.imgtec.com/developers/powervr/documentation/">PowerVR Documentation</a></li>
<li>Older PowerVR blog entries
<ul>
<li><a href="https://web.archive.org/web/20150405010019/http://blog.imgtec.com/powervr/a-look-at-the-powervr-graphics-architecture-tile-based-rendering">http://blog.imgtec.com/powervr/a-look-at-the-powervr-graphics-architecture-tile-based-rendering</a></li>
<li><a href="https://web.archive.org/web/20141230011840/http://blog.imgtec.com/powervr/optimizing-graphics-applications-for-powervr-gpus">http://blog.imgtec.com/powervr/optimizing-graphics-applications-for-powervr-gpus</a></li>
<li><a href="https://web.archive.org/web/20140318032908/http://blog.imgtec.com/powervr/graphics-cores-trying-compare-apples-apples">http://blog.imgtec.com/powervr/graphics-cores-trying-compare-apples-apples</a></li>
<li><a href="https://web.archive.org/web/20140422200753/http://blog.imgtec.com/powervr/understanding-opengl-es-multi-thread-multi-window-rendering">http://blog.imgtec.com/powervr/understanding-opengl-es-multi-thread-multi-window-rendering</a></li>
<li><a href="https://web.archive.org/web/20140915103848/http://blog.imgtec.com/powervr/powervr-gpu-opengl-es-graphics-mobile-for-ten-years-p1">http://blog.imgtec.com/powervr/powervr-gpu-opengl-es-graphics-mobile-for-ten-years-p1</a></li>
<li><a href="https://web.archive.org/web/20150512102802/http://blog.imgtec.com/powervr/powervr-gpu-opengl-es-graphics-mobile-for-ten-years-p2">http://blog.imgtec.com/powervr/powervr-gpu-opengl-es-graphics-mobile-for-ten-years-p2</a></li>
<li><a href="https://web.archive.org/web/20150512092225/http://blog.imgtec.com/powervr/how-to-improve-your-renderer-on-powervr-based-platforms">http://blog.imgtec.com/powervr/how-to-improve-your-renderer-on-powervr-based-platforms</a></li>
<li><a href="https://web.archive.org/web/20140424015848/http://blog.imgtec.com/powervr/micro-benchmark-your-render-on-powervr-series5-series5xt-and-series6-gpus">http://blog.imgtec.com/powervr/micro-benchmark-your-render-on-powervr-series5-series5xt-and-series6-gpus</a></li>
<li><a href="https://web.archive.org/web/20150213202741/http://blog.imgtec.com/powervr/powervr-graphics-we-render-funny">http://blog.imgtec.com/powervr/powervr-graphics-we-render-funny</a></li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="1-get-the-plugin-for-android-studio"><a class="header" href="#1-get-the-plugin-for-android-studio">1. Get the plugin for Android Studio</a></h2>
<p>Adding this plugin provides real-time feedback against a given CheckStyle profile by way of an inspection. to add, grab the <a href="https://github.com/jshiell/checkstyle-idea">Checkstyle-idea plugin</a>, install and restart Studio.</p>
<p>You can install the plugin from within Android Studio by opening the <kbd>Preferences</kbd>, selecting <kbd>Plugins</kbd> in the sidebar, and clicking on <kbd>Browse repositories…</kbd>. Search for <kbd>CheckStyle-IDEA</kbd>, install and restart Android Studio.</p>
<h2 id="2-add-the-projects-checkstyle"><a class="header" href="#2-add-the-projects-checkstyle">2. Add the projects checkstyle</a></h2>
<p>Open <kbd>Preferences</kbd> in Android Studio and navigate to <kbd>Other Settings</kbd>. Add the checkstyle by pressing the plus button:
<img src="android/./Np0F5kh.png" alt="" /></p>
<p>and grabbing the <code>checkstyle.xml</code> file found in the cloned repo:</p>
<p><img src="android/./RE9k3M5.png" alt="" /></p>
<p>Give a description click next and then finish:</p>
<p><img src="android/./sdMOu9D.png" alt="" /></p>
<p>Make sure to check the new style to actually apply it in Android Studio. Last thing I do (but is an optional) is to check the <code>Treat Checkstyle errors as warnings</code>.</p>
<h2 id="3-change-the-project-code-style"><a class="header" href="#3-change-the-project-code-style">3. Change the project code style</a></h2>
<p>To make the formatting quick and easy, you'll most likely want to change the code style set in Android studio. Open <code>Preferences..</code> in Android Studio if it isn't open already and select <code>Editor -&gt; Code Style</code> at the top under <code>Scheme</code> click the manage button:</p>
<p><img src="android/./LC90kDe.png" alt="" /></p>
<p>Chose either project (to change the project style only) default, or make a new on. Click import and add the <code>checkstyle.xml</code> file:</p>
<p><img src="android/./zC3bcB8.png" alt="" /></p>
<p><img src="android/./rddvAmB.png" alt="" /></p>
<p>Ensure that the style you imported the checkstyle to is selected in the dropdown menu now and click apply. Now when you are in a java file, all you have to do is press <code>[command][option][l]</code> (on Mac) and the file indentions and other formatting mistakes. </p>
<div style="break-before: page; page-break-before: always;"></div><p>This document describes the required changes needed to update your codebase using v5 of the SDK to the 6.0.0 version.</p>
<h3 id="java-8"><a class="header" href="#java-8">Java 8:</a></h3>
<p>The 6.0.0 version of the Mapbox Maps SDK for Android introduces the use of Java 8. To fix any Java versioning issues, ensure that you are using Gradle version of <code>3.0</code> or greater. Once you’ve done that, add the following <code>compileOptions</code>  to the <code>android</code> section of your app-level <code>build.gradle</code> file like so:</p>
<pre><code>android {
  ...
  compileOptions {
    sourceCompatibility JavaVersion.VERSION_1_8
    targetCompatibility JavaVersion.VERSION_1_8
  }
}
</code></pre>
<p>This can also be done via your project settings (File &gt; Project Structure &gt; Your_Module &gt; Source Compatibility / Target Compatibility). This is no longer required with Android Studio 3.1.0, as the new dex compiler <a href="https://android-developers.googleblog.com/2017/08/next-generation-dex-compiler-now-in.html">D8</a> will be enabled by default.</p>
<p>Adding the <code>compileOptions</code> section above also solves the following error when updating the Maps SDK version: </p>
<pre><code>Static interface methods are only supported starting with Android N (--min-api 24): com.mapbox.geojson.Geometry com.mapbox.geojson.Geometry.fromJson(java.lang.String)
Message{kind=ERROR, text=Static interface methods are only supported starting with Android N (--min-api 24): com.mapbox.geojson.Geometry com.mapbox.geojson.Geometry.fromJson(java.lang.String), sources=[Unknown source file], tool name=Optional.of(D8)}
</code></pre>
<p>The static interface method used in <code>com.mapbox.geojson.Geometry</code> is compatible with any minSdkVersion (see <a href="https://developer.android.com/studio/write/java8-support.html#supported_features">Supported Java 8 Language Features and APIs</a>).</p>
<h3 id="using-expressions-vs-functions--filters"><a class="header" href="#using-expressions-vs-functions--filters">Using expressions vs functions / filters</a></h3>
<p>You don't need to worry about using expressions in your project if:</p>
<ul>
<li>you don't style any part of your map at runtime</li>
<li>your project only uses <a href="https://www.mapbox.com/maps/">professionally-designed Mapbox map styles</a> (Streets, Outdoors, Satellite Streets, etc.)</li>
<li>your project only uses a style that you've designed via Mapbox Studio</li>
</ul>
<p>We've removed the old way of using <code>Stop</code> functions for runtime styling in the 6.0.0 release of the Maps SDK, so you must use expressions going forward.</p>
<p>If you don't want to re-write your code with runtime styling expressions, you don't have to stop using Mapbox and stop building your project. Just use a version of the Mapbox Maps SDK for Android that is below 6.0.0 and you'll be completely fine until you decide to use 6.0.0 or higher!</p>
<p>The 6.0.0 release changes the syntax used to perform apply data-driven styling of the map. Functions and filters have been replaced by <a href="https://www.mapbox.com/mapbox-gl-js/style-spec/#expressions">expressions</a>. Any <a href="https://www.mapbox.com/mapbox-gl-js/style-spec/#layout-property">layout property</a>, <a href="https://www.mapbox.com/mapbox-gl-js/style-spec/#paint-property">paint property</a>, or <a href="https://www.mapbox.com/mapbox-gl-js/style-spec/#layer-filter">filter</a> can now be specified as an <em>expression</em>. An expression defines a formula for computing the value of the property using the <em>operators</em> described below. The set of expression operators provided by Mapbox GL includes:</p>
<ul>
<li>Mathematical operators for performing arithmetic and other operations on numeric values</li>
<li>Logical operators for manipulating boolean values and making conditional decisions</li>
<li>String operators for manipulating strings</li>
<li>Data operators, providing access to the properties of source features</li>
<li>Camera operators, providing access to the parameters defining the current map view</li>
</ul>
<h3 id="expressions-tips--tricks"><a class="header" href="#expressions-tips--tricks">Expressions tips &amp; tricks:</a></h3>
<ul>
<li>Stops should be listed in ascending order
<ul>
<li>If you’ve got a list of stops where the <code>Object</code> value for each stop is a number, the stops must be in the order of their values from lowest to highest. In the example below, the two stops that affect the radius of the <code>CircleLayer</code>'s circles, are placed in the correct order because 2 is less than 180:</li>
</ul>
</li>
</ul>
<pre><code>    circleRadius(
      interpolate(
        exponential(1.75f),
        zoom(),
        stop(12, 2),
        stop(22, 180)
    )),
</code></pre>
<ul>
<li>Wrap Android <code>int</code> colors with the color expression
<ul>
<li><a href="https://www.mapbox.com/mapbox-gl-js/style-spec/#expressions">The</a> <a href="https://www.mapbox.com/mapbox-gl-js/style-spec/#expressions">Mapbox</a> <a href="https://www.mapbox.com/mapbox-gl-js/style-spec/#expressions">style specif</a><a href="https://www.mapbox.com/mapbox-gl-js/style-spec/#expressions">i</a><a href="https://www.mapbox.com/mapbox-gl-js/style-spec/#expressions">cation</a> exposes the <code>rgb()</code> and <code>rgba()</code> color expressions. To convert an Android <code>int</code> color to a color expression, you need to wrap it with <code>color(int color)</code>. For example:</li>
</ul>
</li>
</ul>
<pre><code>stop(0, color(Color.parseColor(&quot;#F2F12D&quot;))).
</code></pre>
<ul>
<li>When you don’t type your <code>get()</code> expressions explicitly, it is likely that the expression will implicitly <em>expect</em> them to be a certain type — and fail at runtime. They fall back to the style-spec default if they aren’t the expected type. To alter this behavior, use <code>toString()</code>, <code>toNumber()</code>, <code>toColor()</code>, or <code>toBoolean()</code> to explicitly <em>coerce</em> them to the desired type.</li>
</ul>
<h3 id="plugin-support"><a class="header" href="#plugin-support">Plugin support:</a></h3>
<ul>
<li>Deprecation of setXListener
<ul>
<li>With the 6.0.0 release we are allowing listeners to be set through <code>addXListener</code> to support notifying multiple listeners for plugin support. Passing a <code>null</code> in the add method will listener not result in clearing any listeners. Please use equivalent <code>remove</code>XListener method instead.</li>
</ul>
</li>
</ul>
<h3 id="location-layer-vs-locationviewtrackingsettings"><a class="header" href="#location-layer-vs-locationviewtrackingsettings">Location layer vs LocationView/trackingsettings:</a></h3>
<p>With the 6.0.0 release, we are removing the deprecated LocationView and related tracking modes from the Maps SDK. These were deprecated in favor of <a href="https://github.com/mapbox/mapbox-plugins-android/tree/master/plugin-locationlayer">the Location</a> <a href="https://github.com/mapbox/mapbox-plugins-android/tree/master/plugin-locationlayer"></a><a href="https://github.com/mapbox/mapbox-plugins-android/tree/master/plugin-locationlayer">Layer</a> <a href="https://github.com/mapbox/mapbox-plugins-android/tree/master/plugin-locationlayer"></a><a href="https://github.com/mapbox/mapbox-plugins-android/tree/master/plugin-locationlayer">Plugin in</a> <a href="https://github.com/mapbox/mapbox-plugins-android/tree/master/plugin-locationlayer">th</a>e <a href="https://github.com/mapbox/mapbox-plugins-android/tree/master/plugin-locationlayer">plugins repository</a>. The plugin directly renders the user’s location in GL instead of relying on a synchronized Android SDK View. The 0.5.0 version of the Location Layer Plugin is compatible with the 6.0.0 release of the Maps SDK.</p>
<h3 id="latlngbounds"><a class="header" href="#latlngbounds"><code>LatLngBounds</code>:</a></h3>
<ul>
<li>The latitude values should be within a range of -90 to 90 when a  <code>LatLngBounds</code> object is created.</li>
<li>LatLngBounds.Builder will create bounds with the shortest possible span.</li>
</ul>
<pre><code>     // The following bounds will be crossing the antimeridian (new date line)
     LatLngBounds latLngBounds = new LatLngBounds.Builder()
      .include(new LatLng(10, -170))
      .include(new LatLng(-10, 170))
      .build();
    
      // latlngBounds.getSpan() will be 20, 20  
    
      // The same could be done with
      latLngBounds = LatLngBounds.from(10, -170, -10, 170); 
    
</code></pre>
<p>Note that if you need bounds created out of the same points but spanning around different part of the earth (forming a much wider bounds)  you can use:</p>
<pre><code>    LatLngBounds latLngBounds = LatLngBounds.from(10, 170, -10, -170);
    // latlngBounds.getSpan() will be 20, 340  
</code></pre>
<ul>
<li>The order of parameters for <code>LatLngBounds.union()</code> has changed. The parameter order for the <code>union()</code> method has been made consistent with other methods. That is: North, East, South, West.</li>
</ul>
<h3 id="geojson-changes"><a class="header" href="#geojson-changes">GeoJSON changes:</a></h3>
<ul>
<li>GeoJSON objects are immutable</li>
<li>All <code>setCoordinates()</code> methods are deprecated</li>
<li>Geometry instantiation methods. </li>
</ul>
<p>The <code>fromCoordinates()</code> method on classes which implement  <code>Geometry</code>, were renamed to <code>fromLngLat()</code>. The method name for the <code>Point</code>  class is <code>fromLngLat()</code>.</p>
<p>The <code>Point</code>, <code>MultiPoint</code>, <code>LineString</code>, <code>MultiLineString</code>, <code>Polygon</code>, and <code>MultiPolygon</code> classes can no longer can be instantiated from an array of <code>double</code>. A  <code>List&lt;Point&gt;</code> should be used instead.</p>
<p>Pre-6.0.0 way:</p>
<pre><code>// release 5.x.x:
 Polygon domTower = Polygon.fromLngLats(new double[][][] {
          new double[][] {
              new double[] {
                  5.12112557888031,
                  52.09071040847704
                  },
              new double[] {
                  5.121227502822875,
                  52.09053901776669
                  },
              new double[] {
                  5.121484994888306,
                  52.090601641371805
                  },
              new double[] {
                  5.1213884353637695,
                  52.090766439912635
                  },
              new double[] {
                  5.12112557888031,
                  52.09071040847704
                  }
              }
          });
</code></pre>
<p>6.0.0+ way:</p>
<pre><code>  // release 6.0.0
  List&lt;List&lt;Point&gt;&gt; lngLats = Arrays.asList(
    Arrays.asList(
      Point.fromLngLat(5.12112557888031, 52.09071040847704),
      Point.fromLngLat(5.121227502822875, 52.09053901776669),
      Point.fromLngLat(5.121484994888306, 52.090601641371805),
      Point.fromLngLat(5.1213884353637695, 52.090766439912635),
      Point.fromLngLat(5.12112557888031, 52.09071040847704)
    )
);
Polygon domTower = Polygon.fromLngLats(lngLats);
</code></pre>
<ul>
<li>Changes to getter methods’ names:</li>
</ul>
<p><code>Feature</code> and <code>FeatureCollection</code> getter methods don’t start with the word <code>get</code> any more. For example:</p>
<ul>
<li>
<p><code>Feature.getId()</code> → <code>Feature.id()</code></p>
</li>
<li>
<p><code>Feature.getProperty()</code> → <code>Feature.property()</code></p>
</li>
<li>
<p><code>FeatureCollection.getFeatures()</code> → <code>FeatureCollection.features()</code>, etc</p>
</li>
<li>
<p>The <code>Position</code> class has been removed from the API.  The <code>Point</code> model class was simplified. A <code>Point</code> no longer holds a <code>Point</code>’s coordinates in a <code>Position</code> object.</p>
</li>
</ul>
<p>Before the 6.0.0 release:</p>
<pre><code>  Position position = Position.fromCoordinates(10, 10);
  Point point = Point.fromCoordinates(position);
  Point anotherPoint = Poin.fromCoordinates(new double[]{10d, 10d});
  double latitude = point.getCoordinates().getLatitude();
  double longitude = point.getCoordinates().getLongitude();
</code></pre>
<p>With the 6.0.0 release, you should do:</p>
<pre><code>Point point = Point.fromLngLat(10, 10);
double latitude = point.getLatitude(); // no longer need to getCoordinates() first
double longitude = point.getLongitude();
</code></pre>
<h3 id="plugin-support-1"><a class="header" href="#plugin-support-1">Plugin support:</a></h3>
<ul>
<li>Deprecation of setXListener
<ul>
<li>With the 6.0.0 release we are allowing listeners to be set through <code>addXListener</code> to support notifying multiple listeners for plugin support. Passing a <code>null</code> in the add method will listener not result in clearing any listeners. Please use equivalent <code>remove</code>XListener method instead.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><p>This document describes the required changes needed to update your code base from a <code>6.x.x</code> version of the Maps SDK for Android to a <code>7.x.x</code> version.</p>
<h2 id="new-mapbox-default-styles"><a class="header" href="#new-mapbox-default-styles">New Mapbox default styles</a></h2>
<p>The default Mapbox style URLs in the <code>Style</code> class have been bumped to their new versions. These visually improved map styles also bring changes to the names of layers. If your project queries for a certain map layer ID, make sure the layer is still present in the new version of <code>Mapbox Streets</code>, <code>Mapbox Light</code>, etc. <a href="https://www.mapbox.com/android-docs/maps/overview/styling-map/#retrieving-a-map-layer">Logging each map style name with a <code>for</code> loop once the map has been loaded</a>, is a great way to to view the names of the style’s layers. You can also use Mapbox Studio in a non-mobile browser to view the z-index order and the names of the style’s layers.</p>
<h2 id="style-object"><a class="header" href="#style-object">Style object</a></h2>
<p><code>7.0.0</code> of the Maps SDK introduces the <code>Style</code> class. A <code>Style</code> object is a representation of the actively shown style on a map. Using the <code>Style</code>  class provides more flexibility to create and adjust styles. The relationship between the map and the underlying style, becomes clearer with a dedicated <code>Style</code> too.</p>
<p>A <code>Style</code>  object <em><strong>must</strong></em> be created and given to the map for the map to appear properly.  Create a <code>Style</code> by using a:</p>
<ul>
<li>default Mapbox style URL via the <code>Style</code> class</li>
<li>custom map style URL from a Mapbox account</li>
<li>JSON string</li>
</ul>
<p>Before <code>7.0.0</code>, the map would default to the Mapbox Streets style if no style URL was given to the Maps SDK. Beginning with <code>7.0.0</code>, there's no longer any defaulting to the Mapbox Streets style. If the style fails to load or an invalid style URL is set, the map will become blank. An error message will be logged in the Android logcat and the <code>MapView.OnDidFailLoadingMapListener</code> callback will be triggered.</p>
<p>Here’s the setup for a <code>Mapbox Streets</code> map if Java 8 lambdas aren’t available:</p>
<pre><code>mapView.getMapAsync(new OnMapReadyCallback() {
  @Override
  public void onMapReady(MapboxMap mapboxMap) {

    mapboxMap.setStyle(Style.MAPBOX_STREETS, new Style.OnStyleLoaded() {
      @Override
      public void onStyleLoaded(@NonNull Style style) {

        // Map is set up and the style has loaded. Now you can add
        // data or make other map adjustments



      }
    });
  }
});
</code></pre>
<p>Here’s the setup for a <code>Mapbox Streets</code> map if Java 8 lambdas are available:</p>
<pre><code>mapView.getMapAsync(mapboxMap -&gt;
  mapboxMap.setStyle(Style.MAPBOX_STREETS, style -&gt; {

    // Map is set up and the style has loaded. Now you can add data or make other map adjustments


  })
);
</code></pre>
<p>Use the <code>fromUri()</code> method if you’d like to load a custom map style URL, rather than a default Mapbox style (e.g. Streets, Light, Satellite Streets, etc.):</p>
<p>Using a URL:
<code>mapboxMap.setStyle(new Style.Builder().fromUri(UNIQUE_STYLE_URL));</code></p>
<p>Using JSON:
<code>mapboxMap.setStyle(new Style.Builder().fromJson(UNIQUE_STYLE_JSON));</code></p>
<p>Use a builder object to compose all components of a style. <code>Style.Builder()</code> provides additional style-related components such as sources, layers, images. Use the builder to configure the style transition options.</p>
<pre><code>mapboxMap.setStyle(new Style.Builder()
         .withLayer(
           new BackgroundLayer(&quot;bg&quot;)
             .withProperties(backgroundColor(rgb(120, 161, 226)))
         )
         .withLayer(
           new SymbolLayer(&quot;symbols-layer&quot;, &quot;symbols-source&quot;)
             .withProperties(iconImage(&quot;test-icon&quot;))
         )
         .withSource(
           new GeoJsonSource(&quot;symbols-source&quot;, testPoints)
         )
         .withImage(&quot;test-icon&quot;, markerImage)
);
</code></pre>
<p>Get the map’s <code>Style</code> to add a source or layer at a later point in your project:</p>
<pre><code>mapboxMap.getStyle().addLayer(layerObject);


mapboxMap.getStyle().addSource(sourceObject);
</code></pre>
<h2 id="xml-attributes"><a class="header" href="#xml-attributes">XML attributes</a></h2>
<p>The <code>mapbox_styleUrl</code> and <code>mapbox_styleJson</code> XML attributes have been removed from <a href="https://github.com/mapbox/mapbox-gl-native/blob/master/platform/android/MapboxGLAndroidSDK/src/main/res/values/attrs.xml">the list of useable XML attributes.</a>  As described above, set the map style URL or JSON inside of the <code>onMapReady()</code> callback.</p>
<h2 id="new-latlng--latlngbounds-wrapping"><a class="header" href="#new-latlng--latlngbounds-wrapping">New <code>LatLng</code> &amp; <code>LatLngBounds</code> wrapping</a></h2>
<p>Beginning in <code>7.0.0</code>, <code>LatLng</code> and <code>LatLngBounds</code> longitude values are no longer wrapped from -180 to 180. In order to represent bounds which cross the International Date Line, create longitude pairs of 170 and 190 or -170 and -190.</p>
<h2 id="listener-removal"><a class="header" href="#listener-removal">Listener removal</a></h2>
<p>A couple of releases before <code>7.0.0</code>, singular callback methods have been deprecated. Starting in <code>7.0.0</code>, we are removing all deprecated listeners from the Maps SDK for Android. You can now register multiple callbacks at the same time for specific events. Some examples include registering multiple camera callbacks or map change events. <a href="https://www.mapbox.com/android-docs/maps/overview/events/">More about map events</a>.</p>
<h2 id="dedicated-map-change-events"><a class="header" href="#dedicated-map-change-events">Dedicated map change events</a></h2>
<p>Instead of capturing and transmitting all map events to listeners, the <code>7.0.0</code> release introduces a callback for each map change event which we support. This limits the overhead caused by the construct as well make it more easy to integrate map change event listeners.</p>
<h2 id="mapclicklistener-booleans"><a class="header" href="#mapclicklistener-booleans"><code>MapClickListener</code> booleans</a></h2>
<p>The <code>OnMapClickListener</code> and <code>OnMapLongClickListener</code> interfaces now return a <code>boolean</code>. Add <code>return true</code> if the click should be consumed and not passed further to other listeners registered afterwards. Otherwise, add <code>return false</code>.</p>
<h2 id="markerview-removal"><a class="header" href="#markerview-removal">MarkerView removal</a></h2>
<p>The <code>MarkerView</code> has been deprecated for a while and with <code>7.0.0</code>, it has been removed from the Maps SDK. The Maps SDK <code>MarkerView</code> renders and synchronizes an Android SDK View on top of a map. <code>MarkerView</code> functionality is now provided in the <a href="https://www.mapbox.com/android-docs/plugins/overview/markerview/">Mapbox MarkerView Plugin for Android</a>.</p>
<h2 id="annotations-deprecation"><a class="header" href="#annotations-deprecation">Annotations deprecation</a></h2>
<p>Starting in <code>7.0.0</code>, the old concept of annotations is deprecated. Classes such as <code>Polygon</code>, <code>Polyline</code>, and <code>Marker</code> will not longer be maintained. This also means classes such as <code>PolygonOptions</code> and <code>PolylineOptions</code> should not be used. Lastly, this also means that methods such as <code>addPolygon()</code>, <code>addPolyline()</code>, or <code>addMarker()</code> should not be used.</p>
<p>The Maps SDK is now using a more powerful, low-level layer system for adding annotations. A <code>FillLayer</code> should be used to create a polygon, a <code>CircleLayer</code>  to create a circle, a <code>LineLayer</code> to create a polyline, and a <code>SymbolLayer</code> to create marker icons and text. To help interact with this annotation system, Mapbox now offers and recommends <a href="https://www.mapbox.com/android-docs/plugins/overview/annotation/">the Mapbox Annotation Plugin for Android</a>. The plugin obfuscates the boilerplate code which is needed to adjust various properties of map text, icons, lines, circles, and polygons.</p>
<h2 id="locationcomponent"><a class="header" href="#locationcomponent">LocationComponent</a></h2>
<p>The Maps SDK now has a <a href="https://www.mapbox.com/android-docs/maps/overview/location-component/"><code>LocationComponent</code></a>. It’s responsible for displaying and customizing a device’s location on a Mapbox map. In the past, <a href="https://www.mapbox.com/android-docs/plugins/overview/location-layer/">the Location Layer Plugin</a> was used for this, but the plugin has now been deprecated. No further work is being put into the plugin and we strongly recommend that you use the <code>LocationComponent</code>. </p>
<p><a href="https://github.com/mapbox/mapbox-android-demo/tree/b5970d57e5dac225093ec5923ec92446f3e79146/MapboxAndroidDemo/src/main/java/com/mapbox/mapboxandroiddemo/examples/location">See the 7.0.0.-compatible LocationComponent examples in the Mapbox Android Demo app</a> to see correct code for using the <code>LocationComponent</code> in <code>7.0.0</code>.</p>
<p>In order to avoid <code>java.lang.NullPointerException: Attempt to invoke virtual method 'boolean com.mapbox.mapboxsdk.maps.Style.isFullyLoaded()' on a null object reference</code>, <a href="https://github.com/mapbox/mapbox-android-demo/blob/b5970d57e5dac225093ec5923ec92446f3e79146/MapboxAndroidDemo/src/main/java/com/mapbox/mapboxandroiddemo/examples/location/LocationComponentActivity.java#L67">the provided style parameter in the LocationComponent#activate method</a> has to be <code>@NonNull</code> and fully loaded. The best way is to <a href="https://github.com/mapbox/mapbox-android-demo/blob/b5970d57e5dac225093ec5923ec92446f3e79146/MapboxAndroidDemo/src/main/java/com/mapbox/mapboxandroiddemo/examples/location/LocationComponentActivity.java#L54-L55">pass the style provided in the OnStyleLoaded callback</a>.</p>
<p>The component is no longer restricting the max/min zoom levels of the map to ZL18-ZL2 on activation. This can be achieved with the <code>MapboxMapOptions#maxZoomPreference</code> or <code>MapboxMap#setMaxZoomPreference</code> and the equivalent <code>minZoomPreference</code>.</p>
<h2 id="java-7"><a class="header" href="#java-7">Java 7</a></h2>
<p>Starting in <code>7.0.0</code>, support for Java 8 language features is reverted in the Maps SDK. As result, you won’t be forced to enable Java 8 language features in your project. You can remove the following code block from the <code>android</code> section of your app’s <code>build.gradle</code> file:</p>
<pre><code>compileOptions {
     sourceCompatibility JavaVersion.VERSION_1_8
     targetCompatibility JavaVersion.VERSION_1_8
}
</code></pre>
<h2 id="offlineregiondefinition"><a class="header" href="#offlineregiondefinition">OfflineRegionDefinition</a></h2>
<p>A new type of offline region was introduced several releases before <code>7.0.0</code>. This region is based on a specific geometry instead of a bounding box. Because we couldn’t change the interface definition in a minor Maps SDK release, this update was postponed until the <code>7.0.0</code> release. This update adds more common elements to the interface definition.</p>
<h2 id="location-services-and-liblocation-1xx"><a class="header" href="#location-services-and-liblocation-1xx">Location services and liblocation <code>1.X.X</code></a></h2>
<p><a href="https://www.mapbox.com/android-docs/core/overview/">Read the latest information and up-to-date code snippets about Mapbox’s Android Core library</a>.</p>
<h2 id="new-plugin-naming"><a class="header" href="#new-plugin-naming">New plugin naming</a></h2>
<p><a href="https://www.mapbox.com/android-docs/plugins/overview/">The Mapbox Plugins for Android</a> are heavily dependent on the major semantic versioning number of the Maps SDK. They either won't compile or hide runtime bugs when paired with a different major version of the Maps SDK. To make the transition between versions easier and more educated without the need to jump into changelogs and compare repositories, we used the <code>7.0.0</code> release to make a small but helpful tweak to the plugins’ dependency names. The plugins’ artifacts now have a suffix stating which major version of the Maps SDK the plugins are compatible with. You’ll notice below that <code>v7</code> has been added in front of each plugin’s version number:</p>
<pre><code>mapbox-android-plugin-annotation-v7:0.4.0
mapbox-android-plugin-building-v7:0.5.0
mapbox-android-plugin-localization-v7:0.7.0
mapbox-android-plugin-markerview-v7:0.2.0
mapbox-android-plugin-offline-v7:0.4.0
mapbox-android-plugin-places-v7:0.7.0
mapbox-android-plugin-traffic-v7:0.8.0
</code></pre>
<p><a href="https://search.maven.org/#search%7Cga%7C1%7Cg%3A%22com.mapbox.mapboxsdk%22">https://search.maven.org/#search%7Cga%7C1%7Cg%3A&quot;com.mapbox.mapboxsdk&quot;</a> will show you the latest versions of the plugins.</p>
<h2 id="miscellaneous"><a class="header" href="#miscellaneous">Miscellaneous</a></h2>
<ul>
<li>
<p><code>colorToRgbaString</code> is no longer in the <code>PropertyFactory</code> class. It’s in <a href="https://github.com/mapbox/mapbox-gl-native/blob/release-iowaska/platform/android/MapboxGLAndroidSDK/src/main/java/com/mapbox/mapboxsdk/utils/ColorUtils.java">the new <code>ColorUtils</code> class</a>.</p>
</li>
<li>
<p>The <code>STATE_STYLE_URL</code> constant is no longer available in the <code>MapboxConstants</code> class.</p>
</li>
<li>
<p>The import package path for referencing the <code>Style</code> class has changed. It’s now <code>import com.mapbox.mapboxsdk.maps.Style</code> and no longer <code>import com.mapbox.mapboxsdk.constants.Style</code>.</p>
</li>
<li>
<p>The <code>MapboxMap</code> class’ <code>removeSource()</code> and <code>removeLayer()</code> methods now return booleans. The booleans state whether the removal has been successful. If you’d like to hold on to the reference, fetch it beforehand with respective <code>get</code> methods.</p>
</li>
<li>
<p>Map click listeners can now consume the click event and stop it from being passed to listeners down the list (registered after the current one).</p>
</li>
<li>
<p>Support for the <code>ZoomButtonsController</code> was removed.</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="background-information"><a class="header" href="#background-information">Background Information</a></h2>
<p>Often when you encounter an Android native crash (i.e. one inside C++ not Java) or see a bug report with a log attached all you get is this from Android Studio's logcat:</p>
<pre><code>10-30 10:19:20.848 24358-25130/com.mapbox.mapboxgl.testapp I/mbgl: {Map}[Sprite]: Can't find sprite named 'marsh-16'
10-30 10:19:21.988 24358-25130/com.mapbox.mapboxgl.testapp I/mbgl: {Map}[Android]: Not activating as we are not ready
10-30 10:19:22.008 24358-25130/com.mapbox.mapboxgl.testapp I/mbgl: {Map}[Android]: Not deactivating as we are not ready
10-30 10:19:22.078 24358-24551/com.mapbox.mapboxgl.testapp A/libc: Fatal signal 11 (SIGSEGV), code 1, fault addr 0x3c in tid 24551 (Tkj2y_5pUcsWvCQ)
</code></pre>
<p>The actual crash is the last line. Beyond that it's a segment violation at virtual memory address <code>0x3c</code> we have no useful details.</p>
<h2 id="getting-full-native-logs"><a class="header" href="#getting-full-native-logs">Getting full native logs</a></h2>
<p>The first thing to fix is to change the logcat filter. You want to set the far right box (probably set to &quot;Show only selected application&quot;) to &quot;No Filters&quot;. This will reveal all logs the entire Android system and other apps are spewing to logcat. Some phones (Samsung) are worse than others when it comes to logcat noise.</p>
<p>Next you want to narrow these logs to reveal the &quot;tombstone&quot; (Android speak for a crash report). I have found the easiest way it to type &quot;<code>/DEBUG</code>&quot; into the middle text box (the one with the magnifying glass icon).</p>
<p>You should get something like this:</p>
<pre><code>10-30 10:19:22.138 2982-2982/? E/DEBUG: unexpected waitpid response: n=24551, status=0000000b
10-30 10:19:22.138 2982-2982/? E/DEBUG: tid exited before attach completed: tid 24551
10-30 10:19:22.258 2969-3844/? E/: BitTube(): close sendFd (52)
10-30 10:19:22.258 2969-3844/? E/: BitTube(): close sendFd (53)
10-30 10:27:02.688 2982-2982/? I/DEBUG: *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***
10-30 10:27:02.688 2982-2982/? I/DEBUG: Build fingerprint: 'samsung/zerofltedv/zeroflte:5.1.1/LMY47X/G920IDVU3DOJ6:user/release-keys'
10-30 10:27:02.688 2982-2982/? I/DEBUG: Revision: '11'
10-30 10:27:02.688 2982-2982/? I/DEBUG: ABI: 'arm'
10-30 10:27:02.688 2982-2982/? I/DEBUG: pid: 25808, tid: 27889, name: Tkj2y_5pUcsWvCQ  &gt;&gt;&gt; com.mapbox.mapboxgl.testapp &lt;&lt;&lt;
10-30 10:27:02.688 2982-2982/? I/DEBUG: signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 0x3c
10-30 10:27:02.688 2982-2982/? I/DEBUG:     r0 00000000  r1 00000000  r2 00000000  r3 0000591c
10-30 10:27:02.688 2982-2982/? I/DEBUG:     r4 dbb0b894  r5 d6537940  r6 dbb0b888  r7 dbb0b8c4
10-30 10:27:02.688 2982-2982/? I/DEBUG:     r8 dc50ca20  r9 fffff45c  sl 000000c8  fp dbb0b8b8
10-30 10:27:02.688 2982-2982/? I/DEBUG:     ip e1950d6c  sp dbb0b808  lr e16d386c  pc e182ecf8  cpsr 600e0010
10-30 10:27:02.688 2982-2982/? I/DEBUG:     #00 pc 00360cf8  /data/app/com.mapbox.mapboxgl.testapp-2/lib/arm/libmapbox-gl.so (uv_async_send+8)
10-30 10:27:02.688 2982-2982/? I/DEBUG:     #01 pc 00205868  /data/app/com.mapbox.mapboxgl.testapp-2/lib/arm/libmapbox-gl.so (mbgl::HTTPAndroidRequest::onResponse(int, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt;, std::__1::basic_string&lt;char, std::_
10-30 10:27:02.688 2982-2982/? I/DEBUG:     #02 pc 002033e0  /data/app/com.mapbox.mapboxgl.testapp-2/lib/arm/libmapbox-gl.so (mbgl::nativeOnResponse(_JNIEnv*, _jobject*, long long, int, _jstring*, _jstring*, _jstring*, _jstring*, _jstring*, _jbyteArray*)+1620)
10-30 10:27:02.688 2982-2982/? I/DEBUG:     #03 pc 002798b7  /data/dalvik-cache/arm/data@app@com.mapbox.mapboxgl.testapp-2@base.apk@classes.dex
</code></pre>
<p>This reveals the full native stack trace. However it reports everything using program counter addresses (<code>#00 pc 00360cf8</code>) which does not mean much to us human types. And often the C++ symbols it does helpfully provide, are not so helpful:</p>
<p><code>mbgl::HTTPAndroidRequest::onResponse(int, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt;, std::__1::basic_string&lt;char, std::_</code></p>
<h2 id="extracting-source-files-and-line-numbers"><a class="header" href="#extracting-source-files-and-line-numbers">Extracting source files and line numbers</a></h2>
<p>To make sense of this tombstone, you need to use <code>ndk-stack</code> which is documented <a href="http://developer.android.com/ndk/guides/ndk-stack.html">here</a>. That page lists a few ways to get a tombstone into <code>ndk-stack</code> via file or piping.</p>
<p>To make integrating ndk-stack more easy, this project exposes a couple of <code>make</code> commands such as <code>make android-ndk-stack-{abi}</code>. Since symbolication of arm-v8 doesn't always produce an actionable stacktrace, we advice building and running ndk-stack against arm-v7:</p>
<ul>
<li><code>make clean</code> # this will delete arm-v8 .so files</li>
<li><code>make platform/android/gradle/configuration.gradle</code> # make clean removed this file</li>
<li><code>make run-android-arm-v7</code></li>
<li><code>make android-ndk-stack</code> </li>
</ul>
<p>The output from <code>ndk-stack</code> will be like:</p>
<pre><code>********** Crash dump: **********
Build fingerprint: 'samsung/zerofltedv/zeroflte:5.1.1/LMY47X/G920IDVU3DOJ6:user/release-keys'
pid: 14778, tid: 15013, name: OkHttp https://  &gt;&gt;&gt; com.mapbox.mapboxgl.testapp &lt;&lt;&lt;
signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 0x3c
Stack frame #00 pc 00360cf8  /data/app/com.mapbox.mapboxgl.testapp-2/lib/arm/libmapbox-gl.so (uv_async_send+8): Routine uv_async_send at /home/travis/build/mapbox/mason/mason_packages/.build/libuv-1.7.5/src/unix/async.c:62
Stack frame #01 pc 00205868  /data/app/com.mapbox.mapboxgl.testapp-2/lib/arm/libmapbox-gl.so (mbgl::HTTPAndroidRequest::onResponse(int, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt;, std::__1::basic_string&lt;char, std::_: Routine uv::async::send() at /home/leith/mb/mapbox-gl-native/build/android-arm-v7/../../src/mbgl/util/uv_detail.hpp:124
Stack frame #02 pc 002033e0  /data/app/com.mapbox.mapboxgl.testapp-2/lib/arm/libmapbox-gl.so (mbgl::nativeOnResponse(_JNIEnv*, _jobject*, long long, int, _jstring*, _jstring*, _jstring*, _jstring*, _jstring*, _jbyteArray*)+1620): Routine mbgl::nativeOnResponse(_JNIEnv*, _jobject*, long long, int, _jstring*, _jstring*, _jstring*, _jstring*, _jstring*, _jbyteArray*) at /home/leith/mb/mapbox-gl-native/build/android-arm-v7/../../platform/android/http_request_android.cpp:359 (discriminator 6)
Stack frame #03 pc 002798b7  /data/dalvik-cache/arm/data@app@com.mapbox.mapboxgl.testapp-2@base.apk@classes.dex
</code></pre>
<p>To understand this, lets take <code>(mbgl::HTTPAndroidRequest::onResponse(int, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt;, std::__1::basic_string&lt;char, std::_: Routine uv::async::send() at /home/leith/mb/mapbox-gl-native/build/android-arm-v7/../../src/mbgl/util/uv_detail.hpp:124</code> as an example. In this line we can see the function that crashed is <code>mbgl::HTTPAndroidRequest::onResponse</code> and the source file is <code>src/mbgl/util/uv_detail.hpp</code> on line 124.</p>
<p>This line is <a href="https://github.com/mapbox/mapbox-gl-native/blob/master/src/mbgl/util/uv_detail.hpp#L124">here</a> which agrees with stack frame #00</p>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>Note that debug symbols and PC addresses are specific to the last <code>make</code> command you ran. This means you need to reproduce the crash locally if someone gives you a raw stack trace from another device/build/etc.</p>
<p>I find 90% of the time the line numbers from <code>ndk-stack</code> is enough to spot and fix programming errors in C++. To dig deeper currently requires a complex GDB setup which is documented <a href="https://github.com/mapbox/mapbox-gl-native/wiki/Android-debugging-with-remote-GDB">here</a>. However Google provide some interesting tips on using the Qt IDE in the video I linked to from <a href="https://github.com/mapbox/mapbox-gl-native/issues/2755">here</a></p>
<p>A older version of this guide is <a href="https://github.com/mapbox/mapbox-gl-native/wiki/Symbolicating-Android-crashes">here</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="upgrade-from-4x"><a class="header" href="#upgrade-from-4x">Upgrade from 4.x</a></h1>
<p>We've been hard at work making our maps SDK work even better than previous versions. Both performance improvements and new features have been added to the SDK. This meant we had to change up some of the APIs you were using. This document walks through the steps to take when making the upgrade.</p>
<h3 id="manifest"><a class="header" href="#manifest">Manifest</a></h3>
<p>If your project's manifest file contains the telemetry service. <em>You can remove it</em>. It is now merged automatically using Manifest Merging.</p>
<h3 id="adding-new-lifecycles"><a class="header" href="#adding-new-lifecycles">Adding new lifecycles</a></h3>
<p>Part of supporting Android Nougat means we have to also support the new Multi-Window feature. This required us to move some of the logic to the <code>onStart()</code> and <code>onStop()</code> methods. When switching over to 5.0, Android Studio won't complain about these missing but when compiling your application will immediately crash if you don't add them to the activity:</p>
<pre><code class="language-java">@Override
protected void onStart() {
  super.onStart();
  mapView.onStart();
}

@Override
protected void onStop() {
  super.onStop();
  mapView.onStop();
}
</code></pre>
<p><strong>Note:</strong> These new map view lifecycles are in addition to all the ones required in 4.x</p>
<h3 id="mapbox-attribution-name-changes"><a class="header" href="#mapbox-attribution-name-changes">Mapbox attribution name changes</a></h3>
<p>We've made significant improvements to our attribution naming. All attributes now start with <code>mapbox_</code> for easier identifying and removing any potential conflicts with other libraries. In addition, many of the attributes are now named after their Java counterpart. Instead of listing all the changes that have occurred, you might find the <a href="https://github.com/mapbox/mapbox-gl-native/blob/master/platform/android/MapboxGLAndroidSDK/src/main/res/values/attrs.xml"><code>attrs.xml</code></a> file which has all the names. Some of the common attributes you might use in your XML map view are given in the table below:</p>
<div class="table-wrapper"><table><thead><tr><th>4.x attribute names</th><th style="text-align: center">5.0 attribute names</th></tr></thead><tbody>
<tr><td><code>center_latitude</code></td><td style="text-align: center"><code>mapbox_cameraTargetLat</code></td></tr>
<tr><td><code>center_longitude</code></td><td style="text-align: center"><code>mapbox_cameraTargetLng</code></td></tr>
<tr><td><code>zoom</code></td><td style="text-align: center"><code>mapbox_cameraZoom</code></td></tr>
<tr><td><code>direction</code></td><td style="text-align: center"><code>mapbox_cameraBearing</code></td></tr>
<tr><td><code>tilt</code></td><td style="text-align: center"><code>mapbox_cameraTilt</code></td></tr>
<tr><td><code>style_url</code></td><td style="text-align: center"><code>mapbox_styleUrl</code></td></tr>
<tr><td><code>zoom_max</code></td><td style="text-align: center"><code>mapbox_cameraZoomMax</code></td></tr>
<tr><td><code>zoom_min</code></td><td style="text-align: center"><code>mapbox_cameraZoomMin</code></td></tr>
<tr><td><code>rotate_enabled</code></td><td style="text-align: center"><code>mapbox_uiRotateGestures</code></td></tr>
</tbody></table>
</div>
<p>Note that the <code>access_token</code> attribution doesn't exist anymore, more on this in the next sections.</p>
<h4 id="style-string-name-changes"><a class="header" href="#style-string-name-changes">Style string name changes</a></h4>
<p>You can still access the default map style urls by using <code>mapbox:mapbox_styleUrl=&quot;@string/</code> but the string id's have changed to include <code>mapbox_</code> in front of them. For example, <code>@string/style_light</code> now becomes <code>@string/mapbox_style_light</code>.</p>
<h3 id="mapbox-access-token"><a class="header" href="#mapbox-access-token">Mapbox access token</a></h3>
<p>There is now only one method where you should be setting your access token. If you were previously setting the access token in XML, this is no longer an option. in 4.x you'd set your access token through the <code>MapboxAccountManager</code> object which could either belong in the application class (preferred) or in your activities class before <code>setContentView</code> is called. To set the access token now, see the example below:</p>
<pre><code class="language-java">Mapbox.getInstance(this, &quot;&lt;Access token here&gt;&quot;);
</code></pre>
<p>If you want to get the access token to pass into another API (common when using mapbox-java) you can get it with:</p>
<pre><code class="language-java">Mapbox.getAccessToken()
</code></pre>
<h3 id="user-location-changes"><a class="header" href="#user-location-changes">User location changes</a></h3>
<p>In 5.0 we have made significant changes to the way developers get user location information. We have introduced the <code>LocationSource</code> object and the <code>LocationEngine</code>. Inside your onCreate() method you can include this:</p>
<pre><code>LocationEngine locationEngine = LocationSource.getLocationEngine(this);
</code></pre>
<p>Using the locationEngine object you can now add listeners to handle location changes, request and remove location request and much more. For more information, checkout our <a href="https://www.mapbox.com/mapbox-java/#locationengine">new documentation</a>.</p>
<h3 id="custom-marker-icon"><a class="header" href="#custom-marker-icon">Custom marker icon</a></h3>
<p>Starting in 5.0 we only allow creation of marker icons from a bitmap file. This means if you were creating the icon from a drawable before, you'll now need to convert it to a bitmap before creating the icon object. Which means <code>fromDrawable()</code> method of <code>IconFactory</code> is not available anymore.</p>
<p>Old code:</p>
<pre><code class="language-java">IconFactory iconFactory = IconFactory.getInstance(FooActivity.this);
Drawable iconDrawable = ContextCompat.getDrawable(FooActivity.this, R.drawable.foo_icon);
Icon icon = iconFactory.fromDrawable(iconDrawable);
</code></pre>
<p>New code:</p>
<pre><code class="language-java">IconFactory iconFactory = IconFactory.getInstance(FooActivity.this);
Icon icon = iconFactory.fromResource(R.drawable.foo_icon);
</code></pre>
<h3 id="runtime-zoom-function"><a class="header" href="#runtime-zoom-function">Runtime zoom function</a></h3>
<p>With 5.0, we introduced data-driven-styling which includes changes to the zoom function you might have previously been using. In 4.x it looked like this:</p>
<pre><code class="language-java">layer.setProperties(fillColor(zoom(0.8f,
            stop(1, fillColor(Color.GREEN)),
            stop(4, fillColor(Color.BLUE)),
            stop(12, fillColor(Color.RED)),
            stop(20, fillColor(Color.YELLOW))
        )));
</code></pre>
<p>and now, you have the options of having an exponential or interval behavior, here we are using exponential:</p>
<pre><code class="language-java">//Set a zoom function to update the color of the water
          layer.setProperties(fillColor(zoom(exponential(
                  stop(1f, fillColor(Color.GREEN)),
                  stop(8.5f, fillColor(Color.BLUE)),
                  stop(10f, fillColor(Color.RED)),
                  stop(18f, fillColor(Color.YELLOW))
          ))));
</code></pre>
<h3 id="runtime-nosuchlayerexception-removed"><a class="header" href="#runtime-nosuchlayerexception-removed">Runtime <code>NoSuchLayerException</code> removed</a></h3>
<p>In 5.0 we have removed the <code>NoSuchLayerException</code> commonly used to check if the layer exist in the map or not. The new, more appropriate way of handling this will be first acquiring the layer and then checking if it is null before interacting with it.</p>
<h3 id="other-methods-you-might-be-using"><a class="header" href="#other-methods-you-might-be-using">Other methods you might be using</a></h3>
<div class="table-wrapper"><table><thead><tr><th>4.x method names</th><th style="text-align: center">5.0 method names</th></tr></thead><tbody>
<tr><td><code>MapboxMap.getMaxZoom()</code></td><td style="text-align: center"><code>MapboxMap.getMaxZoomLevel()</code></td></tr>
<tr><td><code>mapView.getStyleUrl()</code></td><td style="text-align: center"><code>mapboxMap.getStyleUrl()</code></td></tr>
<tr><td><code>map.getMarkerViewManager().scheduleViewMarkerInvalidation()</code></td><td style="text-align: center"><code>map.getMarkerViewManager().update()</code></td></tr>
</tbody></table>
</div>
<hr />
<p>This is not actually a migration issue but something you should be aware of when working with SDK and MAS in the same project. You might run into a dependencies conflict when mixing different versions of them because some depend on each other (nested dependencies). In order to avoid it you should tell Gradle what to do within the <code>build.gradle</code> file. For example:</p>
<pre><code class="language-groovy">compile('com.mapbox.mapboxsdk:mapbox-android-sdk:5.0.0@aar') {
        transitive = true
        exclude group: 'com.mapbox.mapboxsdk', module: 'mapbox-java-geojson'
        exclude group: 'com.mapbox.mapboxsdk', module: 'mapbox-android-telemetry'
}

compile 'com.mapbox.mapboxsdk:mapbox-android-ui:2.0.0'
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><p>This document describes a few strategies that can be used to reduce the resulting APK size when using the Mapbox Maps SDK for Android.</p>
<h3 id="1-use-proguard-or-dexguard"><a class="header" href="#1-use-proguard-or-dexguard">1. Use ProGuard or DexGuard</a></h3>
<p><a href="https://developer.android.com/studio/build/shrink-code.html">ProGuard</a> and <a href="https://www.guardsquare.com/en/dexguard">DexGuard</a>, even without obfuscation, will remove unused Java code from your code and its dependencies.</p>
<h3 id="2-drop-architectures-you-dont-need"><a class="header" href="#2-drop-architectures-you-dont-need">2. Drop architectures you don't need</a></h3>
<p>The Mapbox SDK ships with 6 architectures:</p>
<pre><code>./arm64-v8a/libmapbox-gl.so
./armeabi/libmapbox-gl.so
./armeabi-v7a/libmapbox-gl.so
./mips/libmapbox-gl.so
./x86/libmapbox-gl.so
./x86_64/libmapbox-gl.so
</code></pre>
<p>Each of these files add up to the resulting APK. If, for example, your app doesn't need x86 support, you could drop <code>x86</code> and <code>x86_64</code> and save some space. See &quot;ABI splitting&quot; below for details.</p>
<h3 id="3-abi-splitting"><a class="header" href="#3-abi-splitting">3. ABI splitting</a></h3>
<p>This is a feature that lets you build an APK file for each CPU, only containing the relevant native libraries. This process is described in the <a href="http://tools.android.com/tech-docs/new-build-system/user-guide/apk-splits#TOC-ABIs-Splits">Android Studio Project Site</a>.</p>
<p>If you distribute your app via Google Play, you can benefit from this approach through the <a href="https://developer.android.com/google/play/publishing/multiple-apks.html">Multiple APK Support</a> distribution feature.</p>
<h4 id="sample-code"><a class="header" href="#sample-code">Sample code</a></h4>
<p>Leveraging apk splits is one of the tips we give users when it comes to shrinking their apk size. Splitting results in building different apks for the different supported abis in an application. Google Play is optimised to only download the apk for the abi of the device that is installing the app.</p>
<p>Mapbox publishes a <a href="https://play.google.com/store/apps/details?id=com.mapbox.mapboxandroiddemo">Demo App</a> to the Google Play store that showcases core SDK features.</p>
<p>This app is <a href="https://github.com/mapbox/mapbox-android-demo">open source</a> and benefits from APK splitting for smaller binary distribution. You can learn how we do this in the <a href="https://github.com/mapbox/mapbox-android-demo/blob/master/MapboxAndroidDemo/build.gradle"><code>build.gradle</code></a> file.</p>
<h3 id="next"><a class="header" href="#next">Next</a></h3>
<p>The Mapbox team is actively looking at other ways to reduce the SDK size (e.g. <a href="https://github.com/mapbox/mapbox-gl-native/pull/11458">dropping support for deprecated architectures</a>).</p>
<p>If you have questions or ideas that you'd like to share, please <a href="https://github.com/mapbox/mapbox-gl-native/issues/new">get in touch with us</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="iphone"><a class="header" href="#iphone">iPhone</a></h3>
<ul>
<li>iPhone 4S (Apple A5): PowerVR SGX543MP2</li>
<li>iPhone 5 (Apple A6): PowerVR SGX543MP3</li>
<li>iPhone 5S (Apple A7): PowerVR  G6430</li>
<li>iPhone 6 (Apple A8): PowerVR GX6450</li>
</ul>
<h3 id="ipad"><a class="header" href="#ipad">iPad</a></h3>
<ul>
<li>iPad 2 (Apple A5): PowerVR SGX543MP2</li>
<li>iPad 3 (Apple A5X): PowerVR SGX543MP4</li>
<li>iPad 4 (Apple A6X): PowerVR SGX554MP4</li>
<li>iPad Air 1 (Apple A7): PowerVR G6430</li>
<li>iPad Air 2 (Apple A8X): PowerVR GXA6850</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><p>Mapbox Maps SDK for iOS v4.0.0 is the first major version of this SDK since 2015. To upgrade, follow <a href="https://www.mapbox.com/install/ios/">the installation instructions</a>. If you use CocoaPods or Carthage, update the version to <code>~&gt; 4.0</code>, then run <code>pod update</code> or <code>carthage update</code>.</p>
<p>Version 4.0.0 contains <a href="https://www.mapbox.com/ios-sdk/api/4.0.0/">a number of important changes</a>. There are several backwards-incompatible changes to be aware of as you upgrade, which are discussed below.</p>
<h2 id="runtime-styling"><a class="header" href="#runtime-styling">Runtime styling</a></h2>
<p>We made a number of improvements to give you more control over the appearance of a map’s style. These improvements required us to make the following backwards-incompatible API changes to <code>MGLStyleLayer</code> and its subclasses:</p>
<ul>
<li>The layout and paint properties on subclasses of <code>MGLStyleLayer</code> are now of type <code>NSExpression</code> instead of <code>MGLStyleValue</code>. <code>MGLStyleValue</code> has been removed. The “<a href="https://www.mapbox.com/ios-sdk/api/4.0.0/migrating-to-expressions.html">Migrating to Expressions</a>” guide shows you how to migrate your runtime styling code to <code>NSExpression</code>. The “<a href="https://www.mapbox.com/ios-sdk/api/4.0.0/predicates-and-expressions.html">Predicates and Expressions</a>” guide contains full details on how to write expressions that are compatible with style layers.</li>
<li>A small number of <code>NSPredicate</code>s written for v3.7.<em>x</em> may need to cast feature attributes to the correct type, as described in <a href="https://www.mapbox.com/ios-sdk/api/4.0.0/predicates-and-expressions.html#operands">this section of the predicate guide</a>.</li>
</ul>
<p>Additionally, <code>MGLRasterSource</code> was renamed <code>MGLRasterTileSource</code> and <code>MGLVectorSource</code> was renamed <code>MGLVectorTileSource</code>. Xcode automatically provides fix-it suggestions for these changes.</p>
<h2 id="swift-class-methods"><a class="header" href="#swift-class-methods">Swift class methods</a></h2>
<p>If your application is written in Swift, you’ll need to account for the following class methods being converted into class properties. Xcode automatically provides fix-it suggestions for these changes as well:</p>
<div class="table-wrapper"><table><thead><tr><th>Old</th><th>New</th></tr></thead><tbody>
<tr><td><code>MGLStyle.streetsStyleURL()</code> etc.</td><td><code>MGLStyle.streetsStyleURL</code> etc.</td></tr>
<tr><td><code>MGLOfflineStorage.shared()</code></td><td><code>MGLOfflineStorage.shared</code></td></tr>
<tr><td><code>MGLAccountManager.setAccessToken(&quot;pk.…&quot;)</code></td><td><code>MGLAccountManager.accessToken = &quot;pk.…&quot;</code></td></tr>
</tbody></table>
</div>
<h2 id="other-changes"><a class="header" href="#other-changes">Other changes</a></h2>
<p>Any classes, methods, or properties that were deprecated in v3.7.6 are no longer available. See your project’s build errors for details about replacements.</p>
<p>The <code>MGLStyle.localizesLabels</code> property has been replaced by an <code>-[MGLStyle localizeLabelsIntoLocale:]</code> method that applies the same effect. See <a href="https://www.mapbox.com/help/change-language/#mapbox-maps-sdk-for-ios">this guide</a> for more details.</p>
<p><del>The SDK no longer supports 32-bit simulators, such as the iPhone 5 and iPad 2 simulators. The SDK continues to support 32-bit devices, but note that the minimum iOS deployment version will increase to iOS 9.0 in a future release.</del> 32-bit simulator support was temporarily restored in v4.0.1 for CocoaPods compatibility, but it will be removed at some point in the future along with 32-bit device support.</p>
<p>If you have any questions, please <a href="https://www.mapbox.com/contact/support/">contact Mapbox’s support team</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="git-workflow"><a class="header" href="#git-workflow">Git workflow.</a></h1>
<ul>
<li><code>git checkout master</code></li>
<li><code>git pull</code></li>
<li><code>git checkout -b [user]-merge-release-[tag version]</code> e.g. <code>git checkout -b fabian-merge-release-ios-v3.6.0</code></li>
<li><code>git checkout [release branch]</code></li>
<li><code>git pull</code></li>
<li><code>git checkout [user]-merge-relase-[tag version]</code> e.g. <code>git checkout fabian-merge-release-ios-v3.6.0</code></li>
<li><code>git merge [tag]</code> e.g. <code>git merge ios-v3.6.0</code></li>
</ul>
<h1 id="conflict-resolution"><a class="header" href="#conflict-resolution">Conflict resolution.</a></h1>
<p>It is likely you will encounter merge conflicts the solving strategy would be:</p>
<ul>
<li>For core gl files (<code>*.hpp</code> &amp; <code>*.cpp</code>) prefer <code>master</code> version.</li>
<li>For Android and iOS files (<code>*.java</code>, <code>*.graddle</code>, <code>*.xml</code>, <code>*.h</code>, <code>*.m</code>, <code>*.mm</code>) manual merge, prioritize release changes.</li>
</ul>
<h1 id="merge-test"><a class="header" href="#merge-test">Merge test.</a></h1>
<p>Before making a PR use the following commands to test the merge.</p>
<ul>
<li>
<p>Core gl</p>
<ul>
<li><code>make test</code></li>
<li><code>make run-test</code></li>
</ul>
</li>
<li>
<p>Android</p>
<ul>
<li><code>make android-check</code></li>
</ul>
</li>
<li>
<p>iOS &amp; macOS</p>
<ul>
<li><code>make iproj</code></li>
<li>Select iosapp click run.</li>
<li><code>make xproj</code></li>
<li>Select macosapp click run.</li>
</ul>
</li>
</ul>
<h1 id="pull-request"><a class="header" href="#pull-request">Pull Request.</a></h1>
<p>If above tests passed.</p>
<ul>
<li><code>git push origin [user]-merge-relase-[tag version]</code> e.g. <code>git push origin fabian-merge-release-ios-v3.6.0</code></li>
<li>Ping each team member whose changes will be affected by this merge.</li>
</ul>
<h1 id="final-merge"><a class="header" href="#final-merge">Final merge.</a></h1>
<p>Once the PR is approved.</p>
<ul>
<li><code>git checkout master</code></li>
<li><code>git pull</code></li>
<li><code>git merge [user]-merge-relase-[tag version]</code> e.g. <code>git merge fabian-merge-release-ios-v3.6.0</code> </li>
<li><code>git push origin master</code></li>
<li><code>git branch -D [user]-merge-relase-[tag version]</code> e.g. <code>git branch -D fabian-merge-release-ios-v3.6.0</code> </li>
</ul>
<p><strong><em>Merging using github is discouraged.</em></strong> </p>
<p>In any case do not use <code>squash and merge</code> option as this will break git history and introduce orphaned commits.</p>
<h1 id="troubleshooting"><a class="header" href="#troubleshooting">Troubleshooting.</a></h1>
<h2 id="android"><a class="header" href="#android">Android.</a></h2>
<p>Error message:</p>
<pre><code>* What went wrong:
Execution failed for task ':MapboxGLAndroidSDK:lint'.
&gt; Lint found errors in the project; aborting build.
</code></pre>
<p>What went wrong: There are missing translations.</p>
<p>Solution: Notify the Android team.</p>
<div style="break-before: page; page-break-before: always;"></div><p>Congratulations, you’re the proud owner of a new release of the Mapbox Maps SDK for macOS! The process below takes 20–30 minutes, most of it <a href="https://xkcd.com/303/">babysitting the compiler</a>.</p>
<h2 id="when-to-release"><a class="header" href="#when-to-release">When to release</a></h2>
<p>To the extent possible, we release the Mapbox Maps SDK for macOS in tandem with the <a href="https://github.com/mapbox/mapbox-gl-native/wiki/Releasing-the-Mapbox-iOS-SDK">Mapbox Maps SDK for iOS</a>, so that developers who work on both platforms can count on feature parity and the same bug fixes between the two SDKs. However, if a critical bug fix affects only macOS, we may issue an out-of-band release of the macOS SDK; conversely, we may delay the macOS SDK release if a critical issue arises in the iOS SDK.</p>
<h2 id="prepare-for-release"><a class="header" href="#prepare-for-release">Prepare for release</a></h2>
<p><em>Takes under 5 minutes</em></p>
<ol>
<li>Skim the <a href="https://github.com/mapbox/mapbox-gl-native/issues?q=is%3Aopen+is%3Aissue+label%3AmacOS">issues tagged <kbd>macOS</kbd></a> or <a href="https://github.com/mapbox/mapbox-gl-native/issues?utf8=%E2%9C%93&amp;q=is%3Aopen%20is%3Aissue%20macOS%20">issues mentioning “macOS”</a> in case there are any showstoppers.</li>
<li>Run <code>tx pull -a</code> to <a href="https://github.com/mapbox/mapbox-gl-native/blob/master/platform/macos/DEVELOPING.md#adding-a-localization">add or update translations</a>.</li>
<li>Update the first section of <a href="https://github.com/mapbox/mapbox-gl-native/blob/master/platform/macos/CHANGELOG.md">the changelog</a> to reflect any notable changes to the SDK, shared iOS/macOS code, or mbgl since the previous release. <a href="https://github.com/mapbox/mapbox-gl-native/compare/">Compare</a> the previous release tag with master or the release branch to find notable changes. Look in particular for commit messages prefixed with <code>[macos]</code>, <code>[ios, macos]</code>, or <code>[core]</code>.</li>
<li>If <a href="https://github.com/mapbox/mapbox-gl-native/blob/master/platform/macos/docs/img/screenshot.jpg">the screenshot</a> hasn’t been updated in awhile, compose a new version that shows off the new release’s features. Try to show styles, cities, or features <a href="https://github.com/mapbox/mapbox-gl-native/issues/7877">that haven’t been depicted</a> in the macOS SDK screenshot before.</li>
<li>Commit these changes and open a PR to get them reviewed and merged.</li>
</ol>
<h2 id="tag-the-release"><a class="header" href="#tag-the-release">Tag the release</a></h2>
<p><em>Takes under 5 minutes</em></p>
<ol>
<li>Decide on a semver-compliant version number according to <a href="https://github.com/mapbox/mapbox-gl-native/wiki/Versions-and-tagging">these guidelines</a>. The version number should be of the form 0.9.8-alpha.1, 0.9.8-beta.1, 0.9.8-rc.1 (for a release candidate), or 0.9.8 (for a final release).</li>
<li>Run <code>./platform/macos/scripts/update-version.sh v0.9.8</code>, where <em>0.9.8</em> is the semver-compliant version you chose in step 1. Commit the resulting changes with a commit message like <code>macos-v0.9.8</code> and open a PR to get it reviewed and merged.</li>
<li>Tag the merged podspec changes as <code>macos-v0.9.8</code>, where <em>0.9.8</em> is the semver-compliant version you chose in step 1. Push the tag.</li>
</ol>
<h2 id="publish-the-release"><a class="header" href="#publish-the-release">Publish the release</a></h2>
<p><em>Takes 10–15 minutes</em></p>
<ol>
<li>Run <code>xcodebuild -version</code> or <code>xcode-select -p</code> to make sure you’re building with the right version of Xcode.</li>
<li>If this is your first time releasing the Mapbox Maps SDK for macOS:
<ol>
<li>Install <code>wget</code> and <a href="https://github.com/aktau/github-release/"><code>github-release</code></a> from Homebrew and <a href="https://rubygems.org/gems/caffeinate"><code>caffeinate</code></a> from RubyGems.</li>
<li>Add <code>export GITHUB_TOKEN='8BADF00DDEADBEEFC00010FF'</code> to your .bash_profile, where <em>8BADF00DDEADBEEFC00010FF</em> is a <a href="https://help.github.com/articles/creating-a-personal-access-token-for-the-command-line/">new GitHub personal access token</a>.</li>
<li>Optionally, to code-sign Mapbox GL.app, you’ll need to install a provisioning profile for your Mac Developer Program membership.</li>
</ol>
</li>
<li>Make sure your Mac is plugged in, then run <code>make xdeploy</code>. A script will build the SDK, package it up, and finally upload the package to a new GitHub release, all the while keeping your computer from falling asleep.</li>
<li>While you wait, <a href="https://github.com/mapbox/mapbox-gl-native/releases/new/">draft a new release</a>. Add release notes based on the release’s section in the changelog. (Unlike the changelog, release notes accept <code>#123</code> syntax for linking to PRs.) Use one of these templates:
<ul>
<li><a href="releasing/Release-notes-template-for-macOS">Release notes template</a></li>
<li><a href="releasing/Prerelease-notes-template-for-macOS">Prerelease notes template</a></li>
</ul>
</li>
<li>Once the script runs to completion, it should have drafted a new <a href="https://github.com/mapbox/mapbox-gl-native/releases/">GitHub release</a> with binary packages attached. Copy the release notes you drafted above into the new release. Title the release <code>macos-v0.9.8</code> (where <em>0.9.8</em> is the new version). Save the draft.</li>
<li>Check “This is a pre-release” if applicable, then click “Publish release”. Delete the other draft you made.</li>
</ol>
<h2 id="update-the-documentation"><a class="header" href="#update-the-documentation">Update the documentation</a></h2>
<p><em>Takes 5–10 minutes</em></p>
<ol>
<li>Update the <a href="https://mapbox.github.io/mapbox-gl-native/macos/">Mapbox Maps SDK for macOS documentation site</a> (which is also bundled with the SDK):
<ol>
<li>Clone mapbox-gl-native to a mapbox-gl-native-pages folder alongside your main mapbox-gl-native clone, and check out the <code>gh-pages</code> branch.</li>
<li>In your main mapbox-gl-native clone, check out the release branch and run <code>make xdocument STANDALONE=1 OUTPUT=../mapbox-gl-native-pages/macos/0.9.8</code>, where <em>0.9.8</em> is the new SDK version.</li>
<li>In mapbox-gl-native-pages, edit <a href="https://github.com/mapbox/mapbox-gl-native/blob/gh-pages/macos/index.html">macos/index.html</a> and macos/docsets/Mapbox.xml to refer to the new SDK version.</li>
<li>In mapbox-gl-native-pages, edit <a href="https://github.com/mapbox/mapbox-gl-native/blob/gh-pages/macos/Mapbox-macOS-SDK.json">macos/Mapbox-macOS-SDK.json</a> and <a href="https://github.com/mapbox/mapbox-gl-native/blob/gh-pages/macos/Mapbox-macOS-SDK-symbols.json">macos/Mapbox-macOS-SDK-symbols.json</a>.</li>
<li>Commit and push your changes to the <code>gh-pages</code> branch.</li>
</ol>
</li>
<li>If any new style properties or features are supported in the new release, update the “SDK support” tables in the <a href="https://www.mapbox.com/mapbox-gl-js/style-spec/">style specification documentation</a>:
<ol>
<li>If this is your first time updating the style specification documentation, install <code>yarn</code> from Homebrew.</li>
<li>Update the <code>sdk-support</code> objects in <a href="https://github.com/mapbox/mapbox-gl-js/blob/master/src/style-spec/reference/v8.json">v8.json</a>. The <code>macos</code> key in an <code>sdk-support</code> object for a particular property indicates the minimum macOS SDK version that supports that property. If the <code>sdk-support</code> object is missing a <code>macos</code> key, the property is assumed to be unsupported in the macOS SDK.</li>
<li>If the release adds support for features other than properties, update <a href="https://github.com/mapbox/mapbox-gl-js/blob/master/docs/style-spec/_generate/index.html">docs/style-spec/_generate/index.html</a>.</li>
<li>Run <code>yarn install &amp;&amp; yarn run build-style-spec</code> to generate the style specification site.</li>
<li>Commit these changes and open a PR in the mapbox-gl-js repository to get them reviewed and merged. (Keep going while you wait for a review.)</li>
<li>Once the PR is merged, cherry-pick the changes into the mb-pages branch, so that they go live on mapbox.com ahead of the next Mapbox GL JS release.</li>
</ol>
</li>
<li>Edit <a href="https://wiki.openstreetmap.org/wiki/Mapbox_GL#Features">this table</a> at the OpenStreetMap Wiki to correctly indicate the status of any new features.</li>
</ol>
<h2 id="tell-your-friends"><a class="header" href="#tell-your-friends">Tell your friends!</a></h2>
<p><em>Takes under 5 minutes</em></p>
<ol>
<li>If this is your first time releasing the Mapbox Maps SDK for macOS:
<ol>
<li><a href="https://guides.cocoapods.org/making/getting-setup-with-trunk.html#getting-started">Sign up for a CocoaPods trunk account</a>.</li>
<li>Get one of the <a href="https://guides.cocoapods.org/making/getting-setup-with-trunk.html#adding-other-people-as-contributors">Mapbox-macOS-SDK pod</a>’s owners to <a href="https://cocoapods.org/pods/Mapbox-macOS-SDK">add you as an owner</a>.</li>
</ol>
</li>
<li>Once the documentation site finishes publishing the updates, push the podspecs to CocoaPods trunk:
<pre><code class="language-bash">pod trunk push platform/macos/Mapbox-macOS-SDK.podspec
pod trunk push platform/macos/Mapbox-macOS-SDK-symbols.podspec
</code></pre>
</li>
<li>Copy <code>pod</code>’s success message and let Mapbox’s Mobile team know about the new release by sending this message to the <code>#mobile</code> Slack channel if you work for Mapbox or the <code>#gl-collab</code> Slack channel if you don’t.</li>
<li>Submit an update to <a href="https://osmbc.openstreetmap.de/">OSMBC</a> to get a mention in the next issue of <a href="http://www.weeklyosm.eu/">WeeklyOSM</a>.</li>
</ol>
<p>Whew! Now you can close the release’s <a href="https://github.com/mapbox/mapbox-gl-native/milestones/">milestone</a> and create one for the next release!</p>
<div style="break-before: page; page-break-before: always;"></div><p>(Consider <a href="https://github.com/mapbox/mapbox-gl-native/wiki/Releasing-the-Mapbox-macOS-SDK">releasing the Mapbox macOS SDK</a> at the same time.)</p>
<h2 id="version-the-packages"><a class="header" href="#version-the-packages">Version the packages</a></h2>
<ol>
<li>Choose a version number per <a href="http://semver.org/">Semantic Versioning</a> and <a href="releasing/./Versions-and-tagging">our tagging rules</a>. Let's call it <code>ios-vX.Y.Z</code>. If this is a pre-release, go with <code>ios-vX.Y.Z-pre.P</code>, where <code>P</code> begins at <code>1</code> and increments for each pre-release. </li>
<li>If necessary, update <a href="https://raw.githubusercontent.com/mapbox/mapbox-gl-native-ios/master/platform/ios/docs/img/screenshot.png">the screenshot</a>.</li>
<li>Update the version <a href="https://github.com/mapbox/mapbox-gl-native-ios/blob/master/platform/ios/Mapbox-iOS-SDK.podspec#L3">in the podspec</a>, <a href="https://github.com/mapbox/mapbox-gl-native-ios/blob/master/platform/ios/Mapbox-iOS-SDK-snapshot-dynamic.podspec#L3">-snapshot-dynamic podspec</a>, and <a href="https://github.com/mapbox/mapbox-gl-native-ios/blob/master/platform/ios/Mapbox-iOS-SDK-stripped.podspec#L3">-stripped podspec</a>.</li>
<li>Update the <code>CHANGELOG.md</code> for the release.
<ul>
<li>Add today’s date to the header for the release.</li>
<li>#protip: you can use the compare (<code>ios-v#.#.#-previous-beta.#...release-N|master</code>) feature in github to more easily find intra-release changes (i.e. https://github.com/mapbox/mapbox-gl-native-ios/compare/ios-v5.7.0-alpha.1...ios-v5.7.0-beta.1).</li>
</ul>
</li>
<li>Run <code>tx pull -a</code> to <a href="https://github.com/mapbox/mapbox-gl-native-ios/blob/master/platform/ios/DEVELOPING.md#adding-a-localization">add or update translations</a>.</li>
<li>Create a pull request with these changes and have it approved/merged.</li>
<li>Create a tag <code>ios-vX.Y.Z</code>.</li>
<li><code>git push origin ios-vX.Y.Z</code></li>
</ol>
<h2 id="build-and-release"><a class="header" href="#build-and-release">Build and release</a></h2>
<p>The release build and deployment process starts <a href="https://circleci.com/gh/mapbox/mapbox-gl-native-ios">on CircleCI</a> once you push the tag. This will automatically:</p>
<ul>
<li>Build, package, and upload the different release flavors to s3 and GitHub.</li>
<li>Create a draft release <a href="https://github.com/mapbox/mapbox-gl-native-ios/releases/">on GitHub</a>.</li>
</ul>
<p>Once the ~35 minute deployment process is finished, you should:</p>
<ul>
<li>Copy the release notes to the draft GitHub release.</li>
<li>Check that the attached packages are valid.</li>
<li>Push the publish button. 💚</li>
</ul>
<h3 id="the-old-manual-way"><a class="header" href="#the-old-manual-way">The old manual way</a></h3>
<p>In times of dire need, you can still deploy manually by following the instructions in <a href="https://github.com/mapbox/mapbox-gl-native/wiki/Releasing-the-Mapbox-iOS-SDK/8b2f745e62ebde5b8663e5016fe7b50072eaad77">this old revision</a>, which relies on <a href="https://github.com/mapbox/mapbox-gl-native/blob/master/platform/ios/scripts/deploy-packages.sh">this script</a>.</p>
<h2 id="stable-releases"><a class="header" href="#stable-releases">Stable releases</a></h2>
<h3 id="cocoapods"><a class="header" href="#cocoapods">cocoapods</a></h3>
<h5 id="note-you-should-first-register-a-cocoapods-id-and-be-added-as-a-cocoapods-collaborator-for-the-mapbox-ios-sdk-pod"><a class="header" href="#note-you-should-first-register-a-cocoapods-id-and-be-added-as-a-cocoapods-collaborator-for-the-mapbox-ios-sdk-pod">Note: You should first <a href="https://guides.cocoapods.org/making/getting-setup-with-trunk.html#getting-started">register a CocoaPods id</a> and <a href="https://guides.cocoapods.org/making/getting-setup-with-trunk.html#adding-other-people-as-contributors">be added as a CocoaPods collaborator</a> for the <a href="https://cocoapods.org/?q=Mapbox-iOS-SDK">Mapbox-iOS-SDK pod</a></a></h5>
<ul>
<li>Run <code>pod trunk push platform/ios/Mapbox-iOS-SDK.podspec</code>.</li>
</ul>
<h3 id="documentation"><a class="header" href="#documentation">Documentation</a></h3>
<ul>
<li><a href="https://github.com/mapbox/gl-internal/wiki/Updating-documentation-on-release">Update the documentation.</a></li>
</ul>
<h2 id="pre-releases"><a class="header" href="#pre-releases">Pre-releases</a></h2>
<h3 id="documentation-1"><a class="header" href="#documentation-1">Documentation</a></h3>
<p>Publish API documentation in the <a href="https://github.com/mapbox/ios-sdk">mapbox/ios-sdk</a> repo. After generating the docs, only commit the new <code>api/X.X.X/</code> folder — this makes them publicly available, but leaves the stable version as the default.</p>
<div style="break-before: page; page-break-before: always;"></div><p>When working on a change that depends on a change to mapbox-gl-js (shaders, integration tests, style spec), use the followin workflow:</p>
<ol>
<li>Open a work-in-progress PR/branch in <code>mapbox-gl-js</code> with the changes needed there.  (Example: https://github.com/mapbox/mapbox-gl-js/pull/4212 un-skips the integration tests relevant to enabling DDS for text-field, text-transform.)</li>
<li>Open a PR with the proposed changes here, including a commit that updates the mapbox-gl-js submodule to the wip branch from step 1) ☝️. </li>
<li>While waiting for or responding to reviews, <code>mapbox-gl-native/master</code> and <code>mapbox-gl-js/master</code> may continue to move along, including the possibility that <code>-native/master</code> needs to track updates in <code>gl-js/master</code>.  So, from time to time, rebase the branch in step 1) and then the PR branch here.</li>
<li>Once we're 🍏, merge the PR to mapbox-gl-js. If it can be fast-forward merged, then do that (via the command line) -- this saves having to reupdate the submodule SHA in mapbox-gl-native. Otherwise, rebase and merge. Then update the submodule SHA in mapbox-gl-native if necessary, and merge the mapbox-gl-native PR.</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><p>Run <code>git clone https://github.com/mapbox/mapbox-gl-native.git</code> to obtain the source code. This will check out the <code>master</code> branch by default.</p>
<div style="break-before: page; page-break-before: always;"></div><p>In all cases, we follow <a href="http://semver.org">Semantic Versioning</a> to indicate compatibility, breaking changes, and other intentions. </p>
<p>All version numbers should have a <code>v</code> prefix. For iOS, Android, Node.js, and other per-platform bindings that are integrated into this repository, we use an additional prefix on each tag to indicate a platform-specific version as required by tagging needs or marketing.</p>
<p>Examples:</p>
<ul>
<li><code>ios-v3.4.0-beta.1</code></li>
<li><code>android-v0.1.3</code></li>
<li><code>node-v2.0.0</code></li>
</ul>
<h2 id="mapbox-android-sdk"><a class="header" href="#mapbox-android-sdk">Mapbox Android SDK</a></h2>
<p>The Android SDK currently offers three products (from less stable to more stable):</p>
<ol>
<li><code>SNAPSHOT</code> releases: built nightly automatically. E.g., <code>v4.2.0-SNAPSHOT</code>.</li>
<li><code>beta</code> releases: Our main pre-release vehicle. E.g., <code>v4.2.0-beta.1</code>.</li>
<li>Final release: The recommended product for our developers in production. E.g., <code>v4.2.0</code></li>
</ol>
<p>Releases, betas, and snapshots are all built in release mode, by the same build environment under the same <a href="https://github.com/mapbox/mapbox-gl-native/blob/master/platform/android/bitrise.yml">settings</a>. The only difference between them is its version naming (and therefore, level of stability and available features).</p>
<p>They all are distributed either via Maven or Sonatype, like any other Java/Android package. You can get instructions on how to install them in your app in our <a href="https://www.mapbox.com/android-sdk/">documentation page</a>.</p>
<h3 id="final-releases"><a class="header" href="#final-releases">Final releases</a></h3>
<p>Final releases are the recommended product to ship with your apps in the app store. For the Mapbox Android SDK, the major version is incremented whenever a public, documented API is changed in a way that breaks backwards compatibility. E.g <code>v1.2.3</code> would be followed by <code>v2.0.0</code>.</p>
<h3 id="pre-releases-1"><a class="header" href="#pre-releases-1">Pre-releases</a></h3>
<p>In preparation for a release we will ship a number of betas with increased stability (at this moment, we don't use <code>alpha</code> or <code>rc</code>). All betas are publicly ticketed in this repo containing information about their features, known issues, and level of stability (<a href="https://github.com/mapbox/mapbox-gl-native/issues/6418">example</a>). Betas are a great mechanism to get your apps ready before a final release, and to provide timely feedback to the Mapbox team to help us shape the final APIs and feature-set.</p>
<h3 id="snapshots"><a class="header" href="#snapshots">Snapshots</a></h3>
<p>Finally, we publish nightly snapshots. These are not intended for production use, instead they're useful to troubleshoot issues as they're easier to use than building this repo from scratch. Nightly snapshots are built from the <code>master</code> branch and include all the PRs changes landed the previous day.</p>
<h2 id="mapbox-ios-sdk"><a class="header" href="#mapbox-ios-sdk">Mapbox iOS SDK</a></h2>
<p>For the Mapbox iOS SDK, the major version is incremented whenever a public, documented API is changed in a way that breaks backwards compatibility, particularly when a symbol is renamed or removed, but also potentially when the semantics of a symbol change significantly. Changes to the installation process or minimum deployment target also warrant a major version bump.</p>
<p>As much as possible, symbols are marked deprecated long before being marked unavailable, long before being removed outright. Undocumented APIs – even publicly visible ones – are subject to change without notice or major version bump. Undocumented behavior in documented APIs is handled on a case-by-case basis. Changes that only affect Swift bridging are also handled on a case-by-case basis.</p>
<p>We tag alpha releases to provide development snapshots as we work towards a beta. Alphas are unstable and should not be used for production development. We issue a beta release once the major features have landed and we feel confident that a developer can begin working with these features in a shippable application, with an eye towards using the final SDK release in the final application. New APIs may be fluid and unstable until the release candidates. We issue a release candidate once we’ve fixed all the bugs we intend to fix for the final release (allowing for the possibility that additional bugs may be found in the RC).</p>
<h2 id="mapbox-macos-sdk"><a class="header" href="#mapbox-macos-sdk">Mapbox macOS SDK</a></h2>
<p>The Mapbox macOS SDK has yet to reach version 1.0. Therefore, backwards-incompatible changes may be introduced in every release.</p>
<h2 id="mapbox-qt-sdk"><a class="header" href="#mapbox-qt-sdk">Mapbox Qt SDK</a></h2>
<p>The Mapbox Qt SDK has yet to be tagged for a release or prerelease.</p>
<h2 id="core-tags"><a class="header" href="#core-tags">Core tags</a></h2>
<p>In the past, we used to also tag core itself (again, following Semantic Versioning) on the same commit. We no longer do so because all the SDKs are in the same repository, making it much easier to make cross-platform changes without worrying about versioning.</p>
<p>Example: <code>v0.5.5 = ios-v2.1.0-pre.1 = 85124b8</code></p>
<div style="break-before: page; page-break-before: always;"></div><p>To trigger a <strong>complete rebuild</strong>, run <code>make clean</code>. This will remove all local build artifacts. for all platforms. To selectively delete just the build artifacts for a particular platform, delete the respective folder in the <code>build</code> directory.</p>
<p>If you have <strong>[[installed ccache|Workflow → ccache]]</strong>, and if you suspect that it cached a bad artifact, run <code>ccache --cleanup</code> to clear the cache. </p>
<p>If you are having trouble getting the <strong>dependencies</strong> right, you can delete the <code>mason_packages</code> directory, or run <code>make distclean</code>. This means the Makefile and [[CMake|Workflow → CMake]] will automatically install the dependencies again on the next try.</p>
<div style="break-before: page; page-break-before: always;"></div><p>More details for <a href="https://github.com/mapbox/mapbox-gl-native/blob/master/platform/ios/DEVELOPING.md">iOS</a> and <a href="https://github.com/mapbox/mapbox-gl-native/blob/master/platform/macos/DEVELOPING.md">macOS</a>.</p>
<h2 id="building-with-xcode"><a class="header" href="#building-with-xcode">Building with Xcode</a></h2>
<p>Before getting started, make sure you've [[installed all prerequisites for building Mapbox GL|Prerequisites]]</p>
<p>To use Xcode, you'll first need to generate a project based on the [[CMake]] files. To do so, open a Terminal window, and run one of these commands [[from your checkout|Code]] directory.</p>
<p>Run <code>make xproj</code> to create a project for building for <strong>macOS</strong>.<br />
Run <code>make iproj</code> to create a project targeting <strong>iOS</strong>.<br />
Run <code>make qtproj</code> to create a project targeting <strong>Qt</strong>.</p>
<p>This will generate the Xcode project files in distinct directories in the <code>build</code> folder. You can use these workspaces side by side. You should see output along these lines:</p>
<pre><code>$ make xproj
mkdir -p build/macos
(cd build/macos &amp;&amp; cmake -G Xcode ../..)
-- The CXX compiler identification is AppleClang 9.0.0.9000039
-- The C compiler identification is AppleClang 9.0.0.9000039
-- Check for working CXX compiler: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang++
-- Check for working CXX compiler: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang++ -- works
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - done
-- Detecting CXX compile features
-- Detecting CXX compile features - done
-- Check for working C compiler: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang
-- Check for working C compiler: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang -- works
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - done
-- Detecting C compile features
-- Detecting C compile features - done
-- Updating submodules...
-- Downloading: https://nodejs.org/download/release/v6.10.3/SHASUMS256.txt
-- NodeJS: Using node, version v6.10.3
-- Downloading: https://nodejs.org/download/release/v6.10.3/node-v6.10.3-headers.tar.gz
-- Configuring done
-- Generating done
-- Build files have been written to: [...]/build/macos
open platform/macos/macos.xcworkspace
</code></pre>
<p>On subsequent runs of <code>make *proj</code>, you'll see much shorter blurbs, or nothing at all (it'll just open the project in Xcode) when there were no changes in the CMake files.</p>
<h2 id="workspace-structure"><a class="header" href="#workspace-structure">Workspace structure</a></h2>
<h2 id=""><a class="header" href="#"></a></h2>
<div style="break-before: page; page-break-before: always;"></div><p>Release notes are the most visible form of documentation for the Mapbox Map SDK for iOS and macOS, so we take care to write it well and comprehensively. We maintain changelogs on a running basis: if a change is notable enough to appear in the release notes, then the pull request making the change should also update the changelog, following the guidelines below. That way, publishing an SDK version is a simple affair:</p>
<ul>
<li>For <strong>macOS releases</strong>, insert the most recent section of <a href="https://github.com/mapbox/mapbox-gl-native/blob/master/platform/macos/CHANGELOG.md">this changelog</a> into <a href="misc/Release-notes-template-for-macOS">this template</a>. (The template looks similar for iOS.)</li>
<li>For <strong>macOS prereleases</strong>, insert the most recent section of <a href="https://github.com/mapbox/mapbox-gl-native/blob/master/platform/macos/CHANGELOG.md">this changelog</a> into <a href="misc/Prerelease-notes-template-for-macOS">this template</a>. (The template looks similar for iOS.)</li>
</ul>
<p>There’s a lot to read here, but it feels less daunting if you first take a look at some example release notes:</p>
<ul>
<li><a href="https://github.com/mapbox/mapbox-gl-native/releases/ios-v4.0.0">iOS release</a></li>
<li><a href="https://github.com/mapbox/mapbox-gl-native/releases/ios-v4.0.0-rc.1">iOS prerelease</a></li>
<li><a href="https://github.com/mapbox/mapbox-gl-native/releases/macos-v0.7.0">macOS release</a></li>
</ul>
<h2 id="foreword"><a class="header" href="#foreword">Foreword</a></h2>
<p>The forward provides helpful links to related tags. When necessary, it also highlights important compatibility notes, such as the corresponding iOS map SDK version or upcoming compatibility changes.</p>
<h2 id="blurbs"><a class="header" href="#blurbs">Blurbs</a></h2>
<p>Include only changes that impact developers or end users:</p>
<ul>
<li>For final releases: list notable changes since the previous release. This list should be cumulative across all the intervening prereleases. To avoid confusion, omit fixes for regressions that were introduced since the previous release.</li>
<li>For prereleases: list notable changes since the previous release or prerelease. Omit fixes for regressions that were introduced since the previous prerelease, but include fixes for regressions that were present in the preview prerelease. Those fixes may not be listed in the changelog, so you’ll have to make up something on the spot.</li>
</ul>
<h3 id="categories"><a class="header" href="#categories">Categories</a></h3>
<p>For readability, sort the list of changes into several categories:</p>
<ul>
<li>If any category has fewer than three items, combine it with another category or combine it with “Other changes”.</li>
<li>If there are fewer than three categories, use a single, flat list of changes.</li>
<li>Within each category, sort blurbs in order of descending developer or end user impact. List backwards-incompatible changes towards the top.</li>
</ul>
<p>Each blurb describes a single change that is notable from the developer’s or end user’s perspective:</p>
<ul>
<li>Focus on what changed, not how we changed it.</li>
<li>Use complete sentences, but omit the subject “we” to avoid repetitiveness. Cast sentences in the past or past progressive tense, since this is a historical record.</li>
<li>Refer to symbols in backticks so that jazzy can automatically link them to the relevant documentation.</li>
<li>Link to the pull request that implemented the change. For cherry-picked changes, link to the original PR.</li>
</ul>
<h3 id="example-blurbs"><a class="header" href="#example-blurbs">Example blurbs</a></h3>
<ul>
<li>Added the <code>-[MGLImageSource enhance]</code> method for enhancing an image source. You can also set the source’s <code>enhance</code> property to <code>true</code> in style JSON. (#123)</li>
<li>Fixed an issue that sometimes turned the user location view into a teapot. (#456)</li>
<li>Latitudes no longer come after longitudes when formatting <code>CLLocationCoordinate2D</code> instances. To preserve the original behavior, pay a visit to Null Island. (#789)</li>
</ul>
<h2 id="afterword"><a class="header" href="#afterword">Afterword</a></h2>
<p>The afterword points the developer to the published documentation. Ensure that a jazzy docset is located at the linked URL.</p>
<p>For prereleases, note the relevant CocoaPods podspec URLs.</p>
<div style="break-before: page; page-break-before: always;"></div><p>These instructions have been incorporated into the “<a href="https://www.mapbox.com/help/first-steps-ios-sdk/">First steps with the Mapbox iOS SDK</a>” guide.</p>
<div style="break-before: page; page-break-before: always;"></div><p>Each of the GL libraries uses different terminology in its public APIs. This is because each library attempts to feel natural to developers on that platform.</p>
<h2 id="conflicts-in-usage"><a class="header" href="#conflicts-in-usage">Conflicts in usage</a></h2>
<p>The following terms in the Mapbox Style Specification have different meanings on the native platforms. The table below examines these terms along with a limited selection of terms from the GL libraries’ public APIs. Definitions in <em>italics</em> denote concepts that the Mapbox GL developers have no control over.</p>
<div class="table-wrapper"><table><thead><tr><th>Term</th><th>Web</th><th>iOS/macOS</th><th>Android</th></tr></thead><tbody>
<tr><td>annotation</td><td>Directions API metadata</td><td>a point or shape overlay</td><td><em>Java language feature</em>; Directions API metadata</td></tr>
<tr><td>attribute</td><td>part of an HTML element</td><td>vector tile metadata; Directions API metadata</td><td>—</td></tr>
<tr><td>bindings</td><td>Node something-something</td><td><em>reactive programming built into Objective-C/Swift</em></td><td><em>reactive programming in Java?</em></td></tr>
<tr><td>class</td><td>a way to toggle paint properties</td><td><em>language feature</em></td><td><em>language feature</em></td></tr>
<tr><td>filter</td><td>a way to hide features in a layer</td><td><em>Apple compositing feature</em></td><td>a way to hide features in a layer</td></tr>
<tr><td>function</td><td><em>JavaScript language feature</em>; a variable property value</td><td><em>2 different Objective-C/Swift language features</em></td><td><em>Java language feature</em>; a variable property value</td></tr>
<tr><td>id</td><td>unique identifier</td><td><em>Objective-C language keyword</em></td><td>unique identifier</td></tr>
<tr><td>layer</td><td>similar to an overlay, but part of the map</td><td><em>Apple animation feature</em></td><td>similar to an overlay, but part of the map</td></tr>
<tr><td>map view</td><td>an occasion a map is viewed</td><td>a container for a map</td><td>a container for a map</td></tr>
<tr><td>region</td><td>—</td><td>akin to bounding box</td><td>bundle of resources for offline usage</td></tr>
<tr><td>plugin</td><td><em>browser feature</em>; GL helper library</td><td>GL helper library; <em>obscure application extension feature</em> (macOS)</td><td>GL helper library</td></tr>
<tr><td>point</td><td>1D shape</td><td>unit of distance; 1D shape</td><td>1D shape</td></tr>
<tr><td>property</td><td><em>JavaScript language feature</em>; an option for a style layer or vector feature</td><td><em>Objective-C/Swift language feature</em></td><td><em>Java language feature</em>; an option for a style layer or vector feature</td></tr>
</tbody></table>
</div>
<h2 id="platform-specific-naming-conventions"><a class="header" href="#platform-specific-naming-conventions">Platform-specific naming conventions</a></h2>
<p>These differences in terminology have led to a number of differences in the libraries’ public APIs, as illustrated in the following table. 🛣 denotes a term used in a client of the Mapbox Directions API that is used together with a GL library (Mapbox GL Directions, MapboxDirections.swift, Mapbox Java SDK).</p>
<div class="table-wrapper"><table><thead><tr><th>Web</th><th>iOS/macOS</th><th>Android</th><th>Qt</th></tr></thead><tbody>
<tr><td>pixel</td><td>point</td><td>pixel</td><td>pixel</td></tr>
<tr><td>—</td><td>pixel</td><td>—</td><td>—</td></tr>
<tr><td>symbol</td><td>—</td><td>—</td><td>—</td></tr>
<tr><td>—</td><td>annotation</td><td>marker, annotation</td><td>annotation</td></tr>
<tr><td>marker</td><td>annotation view</td><td>marker view</td><td>—</td></tr>
<tr><td>sprite</td><td>annotation image</td><td>marker icon</td><td>annotation icon</td></tr>
<tr><td>popup</td><td>callout, callout view; popover (macOS)</td><td>info window</td><td>—</td></tr>
<tr><td>geometry</td><td>shape</td><td>geometry annotation</td><td>shape</td></tr>
<tr><td>source</td><td>content source</td><td>source</td><td>data source</td></tr>
<tr><td>GeoJSON source</td><td>shape source</td><td>GeoJSON source</td><td>GeoJSON data source</td></tr>
<tr><td>raster source</td><td>raster tile source</td><td>raster source</td><td>raster data source</td></tr>
<tr><td>vector source</td><td>vector tile source</td><td>vector source</td><td>vector data source</td></tr>
<tr><td>—</td><td>computed shape source</td><td>custom source</td><td>—</td></tr>
<tr><td>layer</td><td>style layer</td><td>layer</td><td>layer, style layer</td></tr>
<tr><td>—</td><td>OpenGL style layer</td><td>custom layer</td><td>custom layer</td></tr>
<tr><td>property</td><td>attribute</td><td>property</td><td>property</td></tr>
<tr><td>id</td><td>identifier</td><td>id</td><td>id</td></tr>
<tr><td>class</td><td>style class</td><td>—</td><td>class</td></tr>
<tr><td>image</td><td>style image</td><td>image</td><td>image</td></tr>
<tr><td>SDF icon</td><td>template image</td><td>—</td><td>—</td></tr>
<tr><td>expression operator</td><td>expression function, predicate operator</td><td>expression operator</td><td>—</td></tr>
<tr><td>function</td><td>—</td><td>—</td><td>—</td></tr>
<tr><td>filter</td><td>predicate</td><td>filter</td><td>—</td></tr>
<tr><td>rendered features</td><td>visible features</td><td>rendered features</td><td>—</td></tr>
<tr><td>source features</td><td>features in source</td><td>source features</td><td>—</td></tr>
<tr><td>—</td><td>offline pack</td><td>offline region</td><td>—</td></tr>
<tr><td>—</td><td>offline region</td><td>offline region definition</td><td>—</td></tr>
<tr><td>—</td><td>offline storage</td><td>offline manager</td><td>offline cache database</td></tr>
<tr><td>attribution</td><td>attribution</td><td>attribution</td><td>copyrights</td></tr>
<tr><td>bearing</td><td>direction, heading</td><td>bearing</td><td>bearing</td></tr>
<tr><td>padding</td><td>edge insets, edge padding</td><td>content padding</td><td>margins</td></tr>
<tr><td>LngLat</td><td>coordinate</td><td>LatLng</td><td>coordinate</td></tr>
<tr><td>bounds, bbox</td><td>coordinate bounds, region</td><td>LatLng bounds</td><td>bounds</td></tr>
<tr><td>project/unproject</td><td>convert</td><td>project/unproject</td><td>—</td></tr>
<tr><td>camera options</td><td>map camera</td><td>camera</td><td>—</td></tr>
<tr><td>—</td><td>user location annotation view, user dot</td><td>my location view</td><td>—</td></tr>
<tr><td>event listener</td><td>observer</td><td>listener</td><td>signal</td></tr>
<tr><td>handler</td><td>gesture recognizer</td><td>—</td><td>—</td></tr>
<tr><td>—</td><td>swipe</td><td>swipe, fling</td><td>—</td></tr>
<tr><td>click</td><td>tap (iOS) / click (macOS)</td><td>click, touch</td><td>click</td></tr>
<tr><td>double-click</td><td>double-tap (iOS) / double-click (macOS)</td><td>double-touch</td><td>double-click</td></tr>
<tr><td>—</td><td>long tap (iOS) / press (macOS)</td><td>long click, long press</td><td>—</td></tr>
<tr><td>pan</td><td>pan, scroll</td><td>scroll</td><td>pan</td></tr>
<tr><td>scroll, zoom</td><td>pinch</td><td>pinch</td><td>scale</td></tr>
<tr><td>annotation 🛣</td><td>attribute</td><td>annotation</td><td>—</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><p>Follow <a href="misc/Release-notes-style-guide">these guidelines</a> for drafting release notes as part of the running changelog.</p>
<ul>
<li>Replace <code>0.9.8</code> with the macOS SDK release version.</li>
<li>Replace <code>9.8.7</code> with the corresponding iOS SDK release version.</li>
<li>Replace <code>0.9.7</code> with the previous macOS SDK release version.</li>
<li>Insert the most recent section of <a href="https://github.com/mapbox/mapbox-gl-native/blob/master/platform/macos/CHANGELOG.md">this changelog</a> into the middle portion of the template.</li>
<li>There’s no need to use <code>[link](syntax)</code>; GitHub automatically links issue numbers. Replace <code>\[#(\d+)\]\(https://github.com/mapbox/mapbox-gl-native/pull/\1\)</code> in the changelog with <code>#\1</code>.</li>
</ul>
<pre><code class="language-markdown">This version of the Mapbox Maps SDK for macOS corresponds to version 9.8.7 of the Mapbox Maps SDK for iOS. [Changes](https://github.com/mapbox/mapbox-gl-native/compare/macos-v0.9.7...macos-v0.9.8) since [macos-v0.9.7](https://github.com/mapbox/mapbox-gl-native/releases/tag/macos-v0.9.7):

## Packaging

* 
* 
* 

## Styles and data

* 
* 
* 

## User location

* 
* 
* 

## Annotations

* 
* 
* 

## User interaction

* 
* 
* 

## Offline maps

* 
* 
* 

## Networking

* 
* 
* 

## Other changes

* 
* 
* 

Documentation is [available online](https://mapbox.github.io/mapbox-gl-native/macos/0.9.8/) or as part of the download.
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><p>Here's how you can prototype your mobile app in Framer.js with real Mapbox maps. This way your integrated team can move fast on design decisions and use real map styles from day 1.</p>
<p>Mapbox is the best tool for integrated teams of mobile developers, UX designers, and graphic designers. We want to support apps that are custom to the core and tuned exactly for your app. If you already use Framer.js for this purpose, this tutorial should fit right into your process.</p>
<p>The intent of this tutorial is to integrate Mapbox GL JS into your Framer prototypes. For your native apps, you'll use the <a href="http://mapbox.com/ios-sdk">Mapbox iOS SDK</a> and <a href="https://www.mapbox.com/android-sdk/">Mapbox Android SDK</a> for that truly native performance, but since Framer is based on web technologies, our JavaScript code will work perfectly.</p>
<p>To get started, you'll need:</p>
<ul>
<li><a href="http://framerjs.com/">Framer.js</a></li>
<li><a href="https://nodejs.org/en/">nodejs &amp; npm</a></li>
</ul>
<p>If you haven't used a terminal before, the first step will be the hardest, but it'll be all fun after that.</p>
<h2 id="installing"><a class="header" href="#installing">Installing</a></h2>
<p>You can either have an existing Framer project, or create a new, blank one. Framer projects exist on your computers as folders named something like <code>YourProject.framer</code>, and contain CoffeeScript source code and a directory called <code>modules</code>. We're going to install Mapbox GL JS into your project as a module.</p>
<p>Open a <a href="http://blog.teamtreehouse.com/introduction-to-the-mac-os-x-command-line">terminal</a> and navigate to your project folder. If your project is in your Documents folder instead of in your home folder, you'd type <code>~/Documents/my-framer-project</code></p>
<pre><code class="language-sh">$ cd ~/my-framer-project
</code></pre>
<p>Next we'll install the latest version of Mapbox GL JS, using npm:</p>
<pre><code class="language-sh">$ npm install mapbox-gl
</code></pre>
<p>Great: once this is done we have the Mapbox GL JS source code downloaded. To access it from your project, though, we'll need a file that connects it. Create a new file in the <code>modules</code> directory inside of your project and call it <code>npm.coffee</code>. Give it these contents:</p>
<pre><code class="language-coffeescript">exports.mapboxgl = require &quot;mapbox-gl&quot;
</code></pre>
<p>Now your project will be able to require Mapbox GL JS. This is something you'll do at the top of your Framer project, a single line that tells the project to pull in the <code>mapboxgl</code> object, making mapping available.</p>
<pre><code class="language-coffeescript">{ mapboxgl } = require &quot;npm&quot;
</code></pre>
<p>Once you have <code>mapboxgl</code> imported, you can start adding maps.</p>
<p>Two notes before we pull together that source code:</p>
<ul>
<li>Maps are added in HTML elements, and by default Framer makes HTML non-interactive. This is why we add the line <code>mapboxLayer.ignoreEvents = false</code> - this turns events back on, so you can pan and zoom the map. You can omit this line if you want maps to be non-interactive.</li>
<li>Framer scales prototypes at a number of ratios - you might look at your prototype at 75% scale to view a high-resolution mockup on a small laptop screen. Mapbox GL JS will act a little strangely at scales that aren't 100% - panning the map might seem a slower. You can count on the map behaving correctly at 100% scale.</li>
</ul>
<pre><code class="language-coffeescript">{ mapboxgl } = require &quot;npm&quot;


# Here we're creating a new HTML layer
# for the map to live inside of, and scaling
# it to fit the entire window
mapHeight = Screen.height
mapWidth = Screen.width

mapboxLayer = new Layer
mapboxLayer.ignoreEvents = false
mapboxLayer.width = mapWidth
mapboxLayer.height = mapHeight
mapboxLayer.html = &quot;&lt;div id='map'&gt;&lt;/div&gt;&quot;
mapElement = mapboxLayer.querySelector(&quot;#map&quot;)
mapElement.style.height = mapHeight + 'px'

# Set your Mapbox access token here!
mapboxgl.accessToken = '{your_access_token}'

map = new mapboxgl.Map({
    container: mapElement
    zoom: 12.5
    center: [-77.01866, 38.888]
    # here we're using a default style:
    # you can use any of the defaults or a
    # custom style you design in Mapbox Studio
    style: 'mapbox://styles/mapbox/streets-v8'
    hash: true
})
</code></pre>
<p>That's it! The <code>map</code> object you have access to in Framer will have the same methods and properties as <a href="http://mapbox.com/mapbox-gl-js">the Mapbox GL JS API</a>.</p>
<p>For instance, if you want to add a button that zooms the map, you can add this code to the bottom of the prototype:</p>
<pre><code class="language-coffeescript">layerA = new Layer
    x: 100
    y: 100
    width: 200
    height: 200
    borderRadius: 200
    opacity: 1
    backgroundColor: &quot;white&quot;

layerA.onClick -&gt;
    map.zoomTo 10
</code></pre>
<p>Have fun prototyping!</p>
<div style="break-before: page; page-break-before: always;"></div><p>Follow <a href="misc/Release-notes-style-guide">these guidelines</a> for drafting release notes as part of the running changelog.</p>
<ul>
<li>Replace <code>0.9.8-alpha.1</code> with the macOS SDK release version.</li>
<li>Replace <code>9.8.7-alpha.1</code> with the corresponding iOS SDK release version.</li>
<li>Replace <code>0.9.7</code> with the previous macOS SDK release version.</li>
<li>Insert the most recent section of <a href="https://github.com/mapbox/mapbox-gl-native/blob/master/platform/macos/CHANGELOG.md">this changelog</a> into the middle portion of the template, adding blurbs for changes since the last prerelease.</li>
<li>There’s no need to use <code>[link](syntax)</code>; GitHub automatically links issue numbers. Replace <code>\[#(\d+)\]\(https://github.com/mapbox/mapbox-gl-native/pull/\1\)</code> in the changelog with <code>#\1</code>.</li>
</ul>
<pre><code class="language-markdown">This version of the Mapbox Maps SDK for macOS corresponds to version 9.8.7-alpha.1 of the Mapbox Maps SDK for iOS. [Changes](https://github.com/mapbox/mapbox-gl-native/compare/macos-v0.9.7...macos-v0.9.8-alpha.1) since [macos-v0.9.7](https://github.com/mapbox/mapbox-gl-native/releases/tag/macos-v0.9.7):

## Packaging

* 
* 
* 

## Styles and data

* 
* 
* 

## User location

* 
* 
* 

## Annotations

* 
* 
* 

## User interaction

* 
* 
* 

## Offline maps

* 
* 
* 

## Networking

* 
* 
* 

## Other changes

* 
* 
* 

To install this prerelease via CocoaPods, point your Podfile to either of these URLs:

* https://raw.githubusercontent.com/mapbox/mapbox-gl-native/macos-v0.9.8-alpha.1/platform/macos/Mapbox-macOS-SDK.podspec
* https://raw.githubusercontent.com/mapbox/mapbox-gl-native/macos-v0.9.8-alpha.1/platform/macos/Mapbox-macOS-SDK-symbols.podspec

Documentation is [available online](https://mapbox.github.io/mapbox-gl-native/macos/0.9.8-alpha.1/) or as part of the download.
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><div class="table-wrapper"><table><thead><tr><th><strong>⚠️ We're no longer using Bitrise as of November 2017.</strong></th></tr></thead><tbody>
<tr><td>This page only serves as documentation for legacy branches (pre-agua).</td></tr>
</tbody></table>
</div>
<p>Here's the deal with Bitrise. </p>
<ol>
<li>We avoid their GUI for workflow configuration as much as possible, in favor of using <code>bitrise.yml</code> files checked into the repository. The GUI workflow has been set to run:</li>
</ol>
<ul>
<li><code>platform/ios/bitrise.yml</code> for iOS builds</li>
<li><code>platform/android/bitrise.yml</code> for Android builds</li>
</ul>
<ol>
<li>
<p>If you want to change the <code>bitrise.yml</code>, do so and use the <code>bitrise</code> CLI tool (<code>brew install bitrise</code> or <a href="https://github.com/bitrise-io/bitrise/releases">manual install</a>) to <code>bitrise validate</code>. </p>
</li>
<li>
<p>Change the <a href="https://github.com/mapbox/mapbox-gl-native/blob/f59d4ba920bcd132a9e0841a993f1559d96fd480/bitrise.yml#L17"><code>primary</code></a> workflow in your branch to see how changes will be run on Bitrise before merging them to <code>master</code>, affecting all branches (since all branches run their respective <code>primary</code> workflow). You can create alternate workflows, named after branches, to have them run by commits in that branch, but generally we will just use <code>primary</code>. </p>
</li>
<li>
<p>You can also create custom non-branch-related workflows in the <code>bitrise.yml</code> beyond the default <code>primary</code> one, such as eventually where we will have a <code>roll_build</code> or similar workflow to address <a href="https://github.com/mapbox/mapbox-gl-native/issues/2844">#2844</a>. </p>
</li>
<li>
<p>Both <code>[skip ci]</code> and <code>[ci skip]</code> anywhere in commit messages work for our Bitrise setup for this repo as of <a href="https://github.com/mapbox/mapbox-gl-native/commit/f5bb746f6a3e68268c23125ca7acdf549a9cacda"><code>f5bb746</code></a>. </p>
</li>
</ol>
<p>More on Bitrise's steps library (for example, we use the <code>select-xcode-version</code>, <code>script</code>, <code>xcode-test</code>, and <code>slack</code> steps): https://github.com/bitrise-io?utf8=✓&amp;query=steps and http://www.steplib.com</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </body>
</html>
